<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- Librairie PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  html, body { margin: 0; background: #dcdcdc; font-family: Arial, sans-serif; }

  .page-wrapper { display: flex; justify-content: center; padding: 16px; }

  .page {
    width: 210mm; min-height: 297mm; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.25);
    padding: 15mm; display: flex; flex-direction: column; gap: 12px; position: relative;
  }

  .header { display: flex; align-items: flex-start; gap: 10px; }
  .header img { width: 50px; }
  .header-text strong { display: block; font-size: 15px; }

  .fiche-title {
    border: 1px solid #000; font-weight: bold; text-align: center; padding: 4px;
    text-transform: uppercase; margin-top: 8px; font-size: 15px;
  }

  .info-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .info-table td { padding: 4px; vertical-align: middle; }
  .label { font-weight: bold; white-space: nowrap; }
  input, textarea { border: 1px solid #999; border-radius: 3px; padding: 4px; font-size: 13px; max-width: 100%; }

  .section-header {
    background: #1a2d4a; color: #fff; font-weight: bold; text-align: center; padding: 4px;
    text-transform: uppercase; font-size: 13px; border: 1px solid #000; border-bottom: none;
  }
  .section-body { border: 1px solid #000; border-top: none; padding: 8px; font-size: 13px; }

  .incident-line { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px; align-items: center; }
  .big-textarea { width: 100%; min-height: 70px; resize: vertical; }

  .signatures { display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
  .signature-box { flex: 1; min-width: 45%; display: flex; flex-direction: column; align-items: center; }
  .signature-box label { font-weight: bold; margin-bottom: 4px; font-size: 13px; align-self: flex-start; }
  .signature-wrapper { width: 100%; border: 1px dashed #666; border-radius: 4px; height: 120px; position: relative; background: #fff; }
  .signature-wrapper::after{content:"Signez ici"; position:absolute; color:#999; font-size:12px; top:6px; right:8px;}
  canvas.signature-canvas { width: 100%; height: 120px; touch-action: none; }
  .signature-actions { display: flex; justify-content: flex-end; margin-top: 4px; width: 100%; }
  .signature-actions button { border: none; background: #444; color: white; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; }

  .top-buttons { position: fixed; top: 16px; right: 16px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
  .action-btn { background: #000; color: #fff; border: none; border-radius: 6px; padding: 10px 14px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

  /* Loader */
  #loader { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); z-index: 9999; color: #fff; font: 600 16px/1.2 Arial, sans-serif; }
  #loader .box { background: #111; padding: 16px 20px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.4); }

  @media print {
    body { background: #fff; }
    .page-wrapper { padding: 0; }
    .page { box-shadow: none; margin: 0; width: 210mm; min-height: 297mm; padding: 15mm; }
    .top-buttons { display: none !important; }
  }
</style>
</head>

<body>
<div class="top-buttons">
  <button class="action-btn" onclick="window.print()">üìÑ PDF / Imprimer</button>
  <button id="sendBtn" class="action-btn" onclick="sendToServer()">üì® Envoyer</button>
</div>

<!-- Loader -->
<div id="loader"><div class="box">‚è≥ g√©n√©ration & envoi en cours‚Ä¶</div></div>

<div class="page-wrapper">
  <div class="page" id="pageContent">

    <div class="header">
      <img src="logo_otacos.png" alt="O'Tacos Logo" />
      <div class="header-text">
        <strong>HITS BOULOGNE</strong>
        O‚Äôtacos Boulogne-sur-Mer
      </div>
    </div>

    <div class="fiche-title">FICHE INCIDENTS</div>

    <table class="info-table">
      <tr>
        <td class="label">Date :</td>
        <td><input type="date" id="date_fiche" /></td>
        <td class="label" style="text-align:right;">Fiche ouverte pour le salari√© :</td>
        <td><input type="text" id="salarie" placeholder="Nom du salari√©" /></td>
      </tr>
      <tr>
        <td class="label">Responsable :</td>
        <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" style="width:60%;" /></td>
      </tr>
    </table>

    <div class="section-header">DESCRIPTIF DE L‚ÄôINCIDENT</div>
    <div class="section-body">
      <div class="incident-line">
        <input type="checkbox" id="abs_prev" /><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
        <div class="sub-fields" id="abs_prev_fields" style="display:none;">
          <input type="date" id="abs_prev_date" /> Shift pr√©vu √† : <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="abs_np" /><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
        <div class="sub-fields" id="abs_np_fields" style="display:none;">
          <input type="date" id="abs_np_date" /> Shift pr√©vu √† : <input type="text" id="abs_np_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="ret_prev" /><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
        <div class="sub-fields" id="ret_prev_fields" style="display:none;">
          <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="ret_np" /><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
        <div class="sub-fields" id="ret_np_fields" style="display:none;">
          <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="autre" /><label for="autre"><strong>Autre :</strong></label>
        <div class="sub-fields" id="autre_fields" style="display:none;">
          <input type="text" id="autre_detail" placeholder="Pr√©ciser..." style="flex:1; min-width:200px;" />
        </div>
      </div>
    </div>

    <div class="section-header">ORIGINE DE L‚ÄôINCIDENT</div>
    <div class="section-body"><textarea class="big-textarea" id="origine" placeholder="D√©crire l'origine..."></textarea></div>

    <div class="section-header">ACTION CURATIVE</div>
    <div class="section-body"><textarea class="big-textarea" id="action" placeholder="D√©crire l'action corrective..."></textarea></div>

    <div style="margin-top:10px; font-size:14px;">
      <strong>Fait le :</strong> <input type="date" id="fait_le" style="font-size:13px;" />, √† Boulogne-sur-Mer
    </div>

    <div class="signatures">
      <div class="signature-box">
        <label for="signRespCanvas">Signature Responsable</label>
        <div class="signature-wrapper"><canvas id="signRespCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signRespCanvas')">Effacer</button></div>
      </div>
      <div class="signature-box">
        <label for="signSalCanvas">Signature Salari√©</label>
        <div class="signature-wrapper"><canvas id="signSalCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signSalCanvas')">Effacer</button></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== Petites aides UI ===== */
const $ = sel => document.querySelector(sel);
const loader = $("#loader");
const sendBtn = $("#sendBtn");
const showLoader = (s=true)=>{ loader.style.display = s ? "flex":"none"; };
const disableSend = (s=true)=>{ sendBtn.disabled = s; sendBtn.style.opacity = s ? .6 : 1; };

/* ===== Champs conditionnels ===== */
["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
  const box = document.getElementById(id);
  if (!box) return;
  box.addEventListener("change",()=>{
    const sub = document.getElementById(id+"_fields");
    if (sub) sub.style.display = box.checked ? "inline-flex" : "none";
  });
});

/* ===== Signatures (dessin simplifi√©) ===== */
const drawn = new Map(); // id -> bool  (pour savoir si une signature a √©t√© trac√©e)
function setupCanvas(id){
  const c = document.getElementById(id);
  const x = c.getContext("2d", { willReadFrequently: true });
  x.lineWidth = 2;
  x.lineCap = "round";
  let d = false;

  const start = (px,py)=>{ d=true; x.beginPath(); x.moveTo(px,py); };
  const move  = (px,py)=>{ if(!d) return; x.lineTo(px,py); x.stroke(); drawn.set(id,true); };
  const stop  = ()=>{ d=false; };

  c.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
  c.addEventListener("mousemove",e=>move(e.offsetX,e.offsetY));
  c.addEventListener("mouseup", stop);
  c.addEventListener("mouseleave", stop);

  c.addEventListener("touchstart",e=>{
    const r=c.getBoundingClientRect();
    start(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top);
  },{passive:false});
  c.addEventListener("touchmove",e=>{
    const r=c.getBoundingClientRect();
    move(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top);
  },{passive:false});
  c.addEventListener("touchend", stop);
}
function clearCanvas(id){
  const c=document.getElementById(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
  drawn.set(id,false);
}
setupCanvas("signRespCanvas");
setupCanvas("signSalCanvas");

/* ===== utilitaire : downscale + dataURL compact ===== */
function canvasToSmallDataURL(srcCanvas, maxW = 320, mime = 'image/jpeg', quality = 0.8) {
  const w = srcCanvas.width, h = srcCanvas.height;
  const ratio = Math.min(1, maxW / w);
  const dstW = Math.round(w * ratio), dstH = Math.round(h * ratio);
  const off = document.createElement('canvas'); off.width = dstW; off.height = dstH;
  const ctx = off.getContext('2d'); ctx.drawImage(srcCanvas, 0, 0, dstW, dstH);
  return off.toDataURL(mime, quality);
}

/* ===== conversion base64 s√ªre (FileReader) ===== */
function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload  = ()=>resolve(String(r.result).split(',')[1] || '');
    r.onerror = ()=>reject(r.error || new Error('FileReader error'));
    r.readAsDataURL(blob);
  });
}

/* ===== ENVOI DU PDF (robuste) ===== */
async function sendToServer(){
  const WEBAPP_URL = "https://otacos-proxy.contact-otacosbsm.workers.dev/";
  disableSend(true); showLoader(true);

  try{
    const respCanvas = $("#signRespCanvas");
    const salCanvas  = $("#signSalCanvas");
    if (!respCanvas || !salCanvas){
      alert("‚ùå Erreur : les zones de signature ne sont pas disponibles.");
      return;
    }

    // Meta
    const meta = {
      salarie:      ($("#salarie").value || "Inconnu").trim(),
      responsable:  ($("#responsable").value || "N/A").trim(),
      date_fiche:   $("#date_fiche").value || new Date().toISOString().split("T")[0],
    };

    // Clone propre
    const original = $("#pageContent");
    const clone = original.cloneNode(true);

    // Signatures ‚Üí images (si non sign√©es, petite mention)
    const cloneResp = clone.querySelector("#signRespCanvas");
    const cloneSal  = clone.querySelector("#signSalCanvas");

    const placeImg = (node, src, label)=>{
      if (!node) return;
      const wrap = document.createElement("div");
      wrap.style.width="100%"; wrap.style.height="120px"; wrap.style.display="flex"; wrap.style.alignItems="center";
      if (src){
        const img=new Image(); img.src=src; img.style.maxWidth="100%"; img.style.maxHeight="120px";
        wrap.appendChild(img);
      }else{
        const p=document.createElement("div");
        p.textContent = "(pas de signature)";
        p.style.color="#777"; p.style.fontSize="12px"; p.style.marginLeft="8px";
        wrap.appendChild(p);
      }
      node.replaceWith(wrap);
    };

    const respSrc = drawn.get("signRespCanvas") ? canvasToSmallDataURL(respCanvas, 320, 'image/jpeg', 0.85) : "";
    const salSrc  = drawn.get("signSalCanvas")  ? canvasToSmallDataURL(salCanvas,  320, 'image/jpeg', 0.85) : "";
    placeImg(cloneResp, respSrc, "Responsable");
    placeImg(cloneSal,  salSrc,  "Salari√©");

    // Hors √©cran pour html2pdf
    const temp = document.createElement("div");
    temp.style.position="fixed"; temp.style.top="-10000px"; temp.appendChild(clone);
    document.body.appendChild(temp);

    // PDF
    let pdfBlob;
    try{
      pdfBlob = await html2pdf()
        .set({
          margin:[10,10],
          filename:`Fiche_Incident_${meta.salarie}_${meta.date_fiche}.pdf`,
          html2canvas:{ scale:2, useCORS:true, scrollY:0, willReadFrequently:true },
          jsPDF:{ unit:"mm", format:"a4", orientation:"portrait" },
        })
        .from(clone)
        .outputPdf('blob');
    }catch(e){
      console.error("Erreur PDF:", e);
      alert("‚ö†Ô∏è Erreur PDF : " + (e?.message || e));
      return;
    }finally{
      temp.remove();
    }

    // Base64 (sans overflow)
    const b64 = await blobToBase64(pdfBlob);

    // Envoi
    const payload = { meta, b64 };
    let ok=false, msg='';
    try{
      const res = await fetch(WEBAPP_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')){
        const j = await res.json(); ok = j.status === 'ok'; msg = j.message || (ok?'OK':'Erreur serveur');
      }else{
        const txt = await res.text(); ok = res.ok; msg = ok ? 'OK (non-JSON)' : `HTTP ${res.status} - ${txt.slice(0,200)}`;
      }
    }catch(netErr){
      console.error("Envoi √©chou√©:", netErr);
      alert("‚ö†Ô∏è Probl√®me r√©seau lors de l'envoi : " + (netErr?.message || netErr));
      return;
    }

    if (ok){
      alert(`‚úÖ Merci ${meta.responsable},\n\nLa fiche a bien √©t√© enregistr√©e et envoy√©e.`);
    }else{
      alert("‚ö†Ô∏è Erreur c√¥t√© serveur : " + msg);
    }

  }catch(err){
    console.error(err);
    alert("‚ùå Erreur inattendue : " + (err?.message || err));
  }finally{
    showLoader(false); disableSend(false);
  }
}
</script>
</body>
</html>
