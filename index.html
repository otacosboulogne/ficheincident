<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  html,body{margin:0;background:#dcdcdc;font-family:Arial,Helvetica,sans-serif}
  .page-wrapper{display:flex;justify-content:center;padding:16px}
  .page{width:210mm;min-height:297mm;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.25);padding:14mm;display:flex;flex-direction:column;gap:10px;position:relative}
  .header{display:flex;align-items:flex-start;gap:10px}
  .header img{width:46px}
  .header-text strong{display:block;font-size:15px}
  .fiche-title{border:1px solid #000;font-weight:700;text-align:center;padding:4px;text-transform:uppercase;font-size:14px}
  .info-table{width:100%;border-collapse:collapse;font-size:13px}
  .info-table td{padding:3px 4px;vertical-align:middle}
  .label{font-weight:700;white-space:nowrap}
  input,textarea{border:1px solid #999;border-radius:3px;padding:4px;font-size:13px;max-width:100%}
  .section-header{background:#1a2d4a;color:#fff;font-weight:700;text-align:center;padding:4px;text-transform:uppercase;font-size:12.5px;border:1px solid #000;border-bottom:none}
  .section-body{border:1px solid #000;border-top:none;padding:8px;font-size:13px}
  .incident-line{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;align-items:center}
  .big-textarea{width:100%;min-height:70px;resize:vertical}
  .signatures{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .signature-box{flex:1;min-width:46%;display:flex;flex-direction:column}
  .signature-box label{font-weight:700;margin-bottom:4px;font-size:12.5px}
  .signature-wrapper{width:100%;border:1px solid #000;border-radius:4px;height:120px;position:relative;background:#fff}
  canvas.signature-canvas{width:100%;height:120px;touch-action:none}
  .signature-actions{display:flex;justify-content:flex-end;margin-top:4px;width:100%}
  .signature-actions button{border:none;background:#444;color:#fff;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:12px}
  .top-buttons{position:fixed;top:16px;right:16px;z-index:999;display:flex;flex-direction:column;gap:8px}
  .action-btn{background:#000;color:#fff;border:none;border-radius:6px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.3)}
  .hint{position:absolute;right:6px;bottom:6px;color:#9aa;pointer-events:none;font-size:11px}
  #loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999;color:#fff;font:600 16px/1.2 Arial}
  #loader .box{background:#111;padding:16px 20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.4)}
  @media print{
    body{background:#fff}
    .page-wrapper{padding:0}
    .page{box-shadow:none;margin:0;width:210mm;min-height:297mm;padding:14mm}
    .top-buttons{display:none!important}
  }
</style>
</head>
<body>

<div class="top-buttons">
  <button class="action-btn" onclick="window.print()">üìÑ PDF / Imprimer</button>
  <button id="sendBtn" class="action-btn" onclick="sendToServer()">üì® Envoyer</button>
</div>

<div id="loader"><div class="box">‚è≥ g√©n√©ration & envoi en cours‚Ä¶</div></div>

<div class="page-wrapper">
  <div class="page" id="pageContent">

    <div class="header">
      <img src="logo_otacos.png" alt="O'Tacos Logo" />
      <div class="header-text">
        <strong>HITS BOULOGNE</strong>
        O‚Äôtacos Boulogne-sur-Mer
      </div>
    </div>

    <div class="fiche-title">FICHE INCIDENTS</div>

    <table class="info-table">
      <tr>
        <td class="label">Date :</td>
        <td><input type="date" id="date_fiche" /></td>
        <td class="label" style="text-align:right;">Fiche ouverte pour le salari√© :</td>
        <td><input type="text" id="salarie" placeholder="Nom du salari√©" /></td>
      </tr>
      <tr>
        <td class="label">Responsable :</td>
        <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" style="width:60%;" /></td>
      </tr>
    </table>

    <div class="section-header">DESCRIPTIF DE L‚ÄôINCIDENT</div>
    <div class="section-body">
      <div class="incident-line">
        <input type="checkbox" id="abs_prev" /><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
        <div class="sub-fields" id="abs_prev_fields" style="display:none;">
          <input type="date" id="abs_prev_date" />
          Shift pr√©vu √† : <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:70px" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="abs_np" /><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
        <div class="sub-fields" id="abs_np_fields" style="display:none;">
          <input type="date" id="abs_np_date" />
          Shift pr√©vu √† : <input type="text" id="abs_np_shift" placeholder="ex: 18h" style="width:70px" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="ret_prev" /><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
        <div class="sub-fields" id="ret_prev_fields" style="display:none;">
          <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:90px" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="ret_np" /><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
        <div class="sub-fields" id="ret_np_fields" style="display:none;">
          <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:90px" />
        </div>
      </div>

      <div class="incident-line">
        <input type="checkbox" id="autre" /><label for="autre"><strong>Autre :</strong></label>
        <div class="sub-fields" id="autre_fields" style="display:none;">
          <input type="text" id="autre_detail" placeholder="Pr√©ciser..." style="flex:1;min-width:200px" />
        </div>
      </div>
    </div>

    <div class="section-header">ORIGINE DE L‚ÄôINCIDENT</div>
    <div class="section-body"><textarea class="big-textarea" id="origine" placeholder="D√©crire l'origine..."></textarea></div>

    <div class="section-header">ACTION CURATIVE</div>
    <div class="section-body"><textarea class="big-textarea" id="action" placeholder="D√©crire l'action corrective..."></textarea></div>

    <div style="margin-top:10px;font-size:14px">
      <strong>Fait le :</strong>
      <input type="date" id="fait_le" style="font-size:13px" />,
      √† Boulogne-sur-Mer
    </div>

    <div class="signatures">
      <div class="signature-box">
        <label for="signRespCanvas">Signature Responsable</label>
        <div class="signature-wrapper">
          <canvas id="signRespCanvas" class="signature-canvas" width="400" height="120"></canvas>
          <span class="hint">Signez ici</span>
        </div>
        <div class="signature-actions">
          <button type="button" onclick="clearCanvas('signRespCanvas')">Effacer</button>
        </div>
      </div>

      <div class="signature-box">
        <label for="signSalCanvas">Signature Salari√©</label>
        <div class="signature-wrapper">
          <canvas id="signSalCanvas" class="signature-canvas" width="400" height="120"></canvas>
          <span class="hint">Signez ici</span>
        </div>
        <div class="signature-actions">
          <button type="button" onclick="clearCanvas('signSalCanvas')">Effacer</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== Dates auto ===== */
function todayISO(){
  const d=new Date(),m=('0'+(d.getMonth()+1)).slice(-2),day=('0'+d.getDate()).slice(-2);
  return `${d.getFullYear()}-${m}-${day}`;
}
(function initDates(){
  const df=document.getElementById('date_fiche');
  const fl=document.getElementById('fait_le');
  if(df && !df.value) df.value=todayISO();
  if(fl && !fl.value) fl.value=todayISO();
})();

/* ===== Affichage conditionnel ===== */
['abs_prev','abs_np','ret_prev','ret_np','autre'].forEach(id=>{
  const box=document.getElementById(id);
  const sub=document.getElementById(id+'_fields');
  if(!box||!sub) return;
  const sync=()=>{sub.style.display=box.checked?'inline-flex':'none';};
  box.addEventListener('change',sync); sync();
});

/* ===== Signatures ===== */
function setupCanvas(id){
  const c=document.getElementById(id),x=c.getContext('2d');let d=false;
  c.addEventListener('mousedown',e=>{d=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY);});
  c.addEventListener('mousemove',e=>{if(!d)return;x.lineTo(e.offsetX,e.offsetY);x.stroke();});
  ['mouseup','mouseleave'].forEach(ev=>c.addEventListener(ev,()=>d=false));
  c.addEventListener('touchstart',e=>{d=true;const r=c.getBoundingClientRect();x.beginPath();x.moveTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);},{passive:false});
  c.addEventListener('touchmove',e=>{if(!d)return;const r=c.getBoundingClientRect();x.lineTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);x.stroke();},{passive:false});
  c.addEventListener('touchend',()=>d=false);
}
function clearCanvas(id){const c=document.getElementById(id);if(c)c.getContext('2d').clearRect(0,0,c.width,c.height);}
setupCanvas('signRespCanvas'); setupCanvas('signSalCanvas');

/* ===== Helpers export ===== */
function canvasToSmallDataURL(srcCanvas,maxW=340,mime='image/jpeg',quality=.9){
  const w=srcCanvas.width,h=srcCanvas.height,ratio=Math.min(1,maxW/w);
  const off=document.createElement('canvas'); off.width=Math.round(w*ratio); off.height=Math.round(h*ratio);
  off.getContext('2d').drawImage(srcCanvas,0,0,off.width,off.height);
  return off.toDataURL(mime,quality);
}
function textFromInput(el){
  if(!el) return '';
  if(el.type==='date' && el.value){
    const [Y,M,D]=el.value.split('-'); return `${D}/${M}/${Y}`;
  }
  return el.value||'';
}
function checkboxRowToText(box,labelEl,extraText){
  const mark=box && box.checked ? '‚òë' : '‚òê';
  const label=labelEl ? labelEl.textContent.trim() : '';
  const extra=(extraText||'').trim();
  return `${mark} ${label}${extra?(' '+extra):''}`;
}

/* ===== ENVOI + PDF robuste ===== */
async function sendToServer(){
  const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";
  const loader=document.getElementById('loader'); loader.style.display='flex';

  try{
    const respCanvas=document.getElementById('signRespCanvas');
    const salCanvas =document.getElementById('signSalCanvas');

    const meta={
      salarie:document.getElementById('salarie').value||'Inconnu',
      responsable:document.getElementById('responsable').value||'N/A',
      date_fiche:document.getElementById('date_fiche').value||todayISO(),
    };

    /* 1) Clone propre */
    const original=document.getElementById('pageContent');
    const clone=original.cloneNode(true);

    /* 2) Inputs/textarea -> texte */
    clone.querySelectorAll('input, textarea').forEach(el=>{
      if(el.type==='checkbox') return;
      const span=document.createElement('div');
      span.style.minHeight='18px'; span.style.padding='2px 0';
      span.textContent=textFromInput(el);
      el.replaceWith(span);
    });

    /* 3) Cases -> ‚òë/‚òê + libell√© + valeurs */
    const map=[
      ['abs_prev','abs_prev_fields',['abs_prev_date','abs_prev_shift']],
      ['abs_np','abs_np_fields',['abs_np_date','abs_np_shift']],
      ['ret_prev','ret_prev_fields',['ret_prev_duree']],
      ['ret_np','ret_np_fields',['ret_np_duree']],
      ['autre','autre_fields',['autre_detail']],
    ];
    map.forEach(([id,_fields,extraIds])=>{
      const box=original.querySelector('#'+id);
      const cloneRow=clone.querySelector('#'+id)?.closest('.incident-line');
      if(!cloneRow) return;
      const labelEl=cloneRow.querySelector('label[for="'+id+'"]');

      let extraText='';
      (extraIds||[]).forEach(eid=>{
        const src=original.querySelector('#'+eid);
        if(src && src.value){
          if(src.type==='date'){ const [Y,M,D]=src.value.split('-'); extraText+=` ${D}/${M}/${Y}`; }
          else extraText+=` ${src.value}`;
        }
      });

      const lineText=checkboxRowToText(box,labelEl,extraText);
      const p=document.createElement('div'); p.textContent=lineText; p.style.padding='2px 0';
      cloneRow.replaceWith(p);
    });

    /* 4) Textareas libres */
    ['origine','action'].forEach(id=>{
      const src=original.querySelector('#'+id);
      const dst=clone.querySelector('#'+id);
      if(src && dst){
        const dv=document.createElement('div'); dv.style.minHeight='60px'; dv.style.whiteSpace='pre-wrap'; dv.textContent=src.value||'';
        dst.replaceWith(dv);
      }
    });

    /* 5) Signatures -> images */
    const respSmall=canvasToSmallDataURL(respCanvas,360,'image/jpeg',0.92);
    const salSmall =canvasToSmallDataURL(salCanvas ,360,'image/jpeg',0.92);

    const replaceSign=(canvasId,smallSrc,legend)=>{
      const c=clone.querySelector('#'+canvasId);
      if(!c) return;
      const wrap=c.parentElement;
      const img=document.createElement('img'); img.src=smallSrc; img.style.width='100%'; img.style.height='auto';
      const cap=document.createElement('div'); cap.textContent=legend; cap.style.fontSize='11px'; cap.style.marginTop='4px'; cap.style.color='#333';
      const box=document.createElement('div'); box.appendChild(img); box.appendChild(cap);
      wrap.replaceWith(box);
    };
    replaceSign('signRespCanvas',respSmall,'Sign√© : Responsable');
    replaceSign('signSalCanvas' ,salSmall ,'Sign√© : Salari√©');

    /* 6) Remove boutons Effacer */
    clone.querySelectorAll('.signature-actions').forEach(e=>e.remove());

    /* 7) Conteneur offscreen */
    const temp=document.createElement('div');
    temp.style.position='fixed'; temp.style.top='-10000px';
    temp.appendChild(clone); document.body.appendChild(temp);

    /* 8) G√©n√©ration PDF ‚Äì s√©quence robuste pour √©viter la pile infinie */
    const opt={
      margin:[10,10],
      filename:`Fiche_Incident_${meta.salarie}_${meta.date_fiche}.pdf`,
      html2canvas:{scale:1.8,useCORS:true,scrollY:0,willReadFrequently:true},
      jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    };

    // Laisser l'event loop respirer avant html2pdf
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

    let pdfBlob;
    try{
      // √âtapes d√©coup√©es : toPdf() puis output(...)
      const inst = html2pdf().set(opt).from(clone).toPdf();
      await inst; // attend le rendu PDF
      // Deuxi√®me micro-pause (√©vite des boucles internes sur certains navigateurs)
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

      // Essaye l‚ÄôAPI moderne‚Ä¶
      if(typeof inst.output==='function'){
        pdfBlob = await inst.output('blob');
      }else{
        // ‚Ä¶sinon fallback ancien
        pdfBlob = await html2pdf().set(opt).from(clone).outputPdf('blob');
      }
    }catch(pdfErr){
      temp.remove();
      throw pdfErr;
    }
    temp.remove();

    /* 9) blob -> base64 */
    const buf=await pdfBlob.arrayBuffer();
    const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));

    /* 10) Envoi */
    const payload={meta,b64};
    const res=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const ct=res.headers.get('content-type')||'';
    let ok=false,msg='';
    if(ct.includes('application/json')){ const j=await res.json(); ok=j.status==='ok'; msg=j.message||''; }
    else { ok=res.ok; msg=ok?'OK (non-JSON)':`HTTP ${res.status}`; }

    alert(ok?`‚úÖ Merci ${meta.responsable},\n\nLa fiche a bien √©t√© enregistr√©e et envoy√©e.`:`‚ö†Ô∏è Erreur c√¥t√© serveur : ${msg}`);
  }catch(err){
    console.error(err);
    alert('‚ùå Erreur : '+(err?.message||err));
  }finally{
    document.getElementById('loader').style.display='none';
  }
}
</script>
</body>
</html>
