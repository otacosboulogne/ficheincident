<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- G√©n√©ration PDF (SANS integrity pour √©viter le blocage SRI) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
  :root{
    --page-w: 210mm;      /* A4 */
    --page-h: 297mm;
    --pad: 14mm;
    --theme: #1a2d4a;
  }

  html,body{ margin:0; background:#dcdcdc; font-family:Arial, Helvetica, sans-serif; }

  .page-wrapper{ display:flex; justify-content:center; padding:16px; }
  .page{
    width:var(--page-w); min-height:var(--page-h);
    background:#fff; box-shadow:0 0 10px rgba(0,0,0,.25);
    padding:var(--pad); position:relative; display:flex; flex-direction:column; gap:10px;
    overflow:visible;
  }

  /* Emp√™che les coupures mal plac√©es dans le PDF */
  .no-break{ page-break-inside:avoid; break-inside:avoid; }

  .header{ display:flex; align-items:flex-start; gap:10px; }
  .header img{ width:50px; height:auto; }
  .header-text strong{ font-size:15px; display:block; }

  .title{
    border:1px solid #000; font-weight:700; text-align:center; padding:4px 6px;
    text-transform:uppercase; margin-top:6px; font-size:15px;
  }

  .grid{ width:100%; border-collapse:collapse; font-size:13px; }
  .grid td{ padding:4px 6px; vertical-align:middle; }
  .label{ font-weight:bold; white-space:nowrap; }

  input,textarea{
    border:1px solid #999; border-radius:3px; padding:4px 6px; font-size:13px; max-width:100%;
  }
  textarea{ width:100%; min-height:80px; resize:vertical; }

  .section-h{
    background:var(--theme); color:#fff; text-align:center; padding:4px 6px; font-weight:700;
    border:1px solid #000; border-bottom:none; font-size:13px;
  }
  .section-b{ border:1px solid #000; border-top:none; padding:8px; font-size:13px; }

  .row{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:6px; }
  .sub{ display:none; gap:6px; align-items:center; }

  .signatures{ display:flex; flex-wrap:wrap; gap:14px; justify-content:space-between; }
  .sig-box{ flex:1; min-width:46%; }
  .sig-box label{ font-weight:bold; font-size:13px; display:block; margin-bottom:4px; }
  .sig-wrap{
    position:relative; width:100%; height:120px; border:1px dashed #888; border-radius:6px; background:#fff;
  }
  canvas.signature{ width:100%; height:120px; touch-action:none; display:block; }
  .sig-hint{ position:absolute; top:6px; right:10px; font-size:12px; color:#666; }
  .sig-actions{ text-align:right; margin-top:6px; }
  .btn-mini{ font-size:12px; padding:5px 10px; border:none; background:#444; color:#fff; border-radius:4px; cursor:pointer; }

  .toolbar{ position:fixed; top:14px; right:14px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
  .btn{
    background:#000; color:#fff; border:none; border-radius:6px; padding:10px 14px; font-weight:700; cursor:pointer; font-size:14px;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  #loader{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35);
    z-index:10000; color:#fff; font:600 16px/1.2 Arial, sans-serif;
  }
  #loader .box{ background:#111; padding:14px 18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.4); }

  @media print{
    body{ background:#fff; }
    .page-wrapper{ padding:0; }
    .page{ width:var(--page-w); min-height:var(--page-h); padding:var(--pad); box-shadow:none; }
    .toolbar{ display:none!important; }
  }
</style>
</head>

<body>
  <div class="toolbar no-print">
    <button class="btn" onclick="window.print()">üìÑ PDF / Imprimer</button>
    <button id="sendBtn" class="btn" onclick="sendToServer()">üì® Envoyer</button>
  </div>

  <div id="loader"><div class="box">‚è≥ G√©n√©ration & envoi en cours‚Ä¶</div></div>

  <div class="page-wrapper">
    <div class="page" id="pageContent">
      <div class="header no-break">
        <img src="logo_otacos.png" alt="O'Tacos" />
        <div class="header-text">
          <strong>HITS BOULOGNE</strong>
          O‚Äôtacos Boulogne-sur-Mer
        </div>
      </div>

      <div class="title no-break">FICHE INCIDENTS</div>

      <table class="grid no-break">
        <tr>
          <td class="label" style="width:70px;">Date :</td>
          <td style="width:220px;"><input type="date" id="date_fiche" /></td>
          <td class="label" style="text-align:right;">Fiche ouverte pour le salari√© :</td>
          <td style="width:240px;"><input type="text" id="salarie" placeholder="Nom du salari√©" /></td>
        </tr>
        <tr>
          <td class="label">Responsable :</td>
          <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" style="width:60%;" /></td>
        </tr>
      </table>

      <div class="section-h no-break">DESCRIPTIF DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <div class="row">
          <input type="checkbox" id="abs_prev" /><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
          <div class="sub" id="abs_prev_fields">
            <input type="date" id="abs_prev_date" />
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:70px;" />
          </div>
        </div>
        <div class="row">
          <input type="checkbox" id="abs_np" /><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
          <div class="sub" id="abs_np_fields">
            <input type="date" id="abs_np_date" />
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_np_shift" placeholder="ex: 18h" style="width:70px;" />
          </div>
        </div>
        <div class="row">
          <input type="checkbox" id="ret_prev" /><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
          <div class="sub" id="ret_prev_fields">
            <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:90px;" />
          </div>
        </div>
        <div class="row">
          <input type="checkbox" id="ret_np" /><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
          <div class="sub" id="ret_np_fields">
            <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:90px;" />
          </div>
        </div>
        <div class="row">
          <input type="checkbox" id="autre" /><label for="autre"><strong>Autre :</strong></label>
          <div class="sub" id="autre_fields">
            <input type="text" id="autre_detail" placeholder="Pr√©ciser‚Ä¶" style="min-width:220px; flex:1;" />
          </div>
        </div>
      </div>

      <div class="section-h no-break">ORIGINE DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <textarea id="origine" placeholder="D√©crire l'origine‚Ä¶"></textarea>
      </div>

      <div class="section-h no-break">ACTION CURATIVE</div>
      <div class="section-b no-break">
        <textarea id="action" placeholder="D√©crire l'action corrective‚Ä¶"></textarea>
      </div>

      <div class="no-break" style="display:flex; align-items:center; gap:8px; font-size:14px; margin-top:2px;">
        <strong>Fait le :</strong>
        <input type="date" id="fait_le" style="font-size:13px;" />
        <span>, √† Boulogne-sur-Mer</span>
      </div>

      <div class="signatures no-break">
        <div class="sig-box">
          <label for="signRespCanvas">Signature Responsable</label>
          <div class="sig-wrap">
            <canvas id="signRespCanvas" class="signature" width="800" height="240"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions">
            <button class="btn-mini" type="button" onclick="clearCanvas('signRespCanvas')">Effacer</button>
          </div>
        </div>

        <div class="sig-box">
          <label for="signSalCanvas">Signature Salari√©</label>
          <div class="sig-wrap">
            <canvas id="signSalCanvas" class="signature" width="800" height="240"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions">
            <button class="btn-mini" type="button" onclick="clearCanvas('signSalCanvas')">Effacer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* === Champs conditionnels === */
["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
  const box=document.getElementById(id);
  const sub=document.getElementById(id+"_fields");
  if(!box||!sub) return;
  const sync=()=>{ sub.style.display=box.checked?"inline-flex":"none"; };
  box.addEventListener("change",sync); sync();
});

/* === Signatures === */
function setupCanvas(id){
  const c=document.getElementById(id);
  const ctx=c.getContext("2d");
  /* Fond blanc pour √©viter les zones noires dans le PDF */
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
  ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="#000";

  let drawing=false, prev=null;
  const start=(x,y)=>{ drawing=true; prev={x,y}; };
  const move=(x,y)=>{ if(!drawing) return; ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(x,y); ctx.stroke(); prev={x,y}; };
  const stop=()=>{ drawing=false; prev=null; };

  c.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
  c.addEventListener("mousemove",e=>move(e.offsetX,e.offsetY));
  ["mouseup","mouseleave"].forEach(ev=>c.addEventListener(ev,stop));

  c.addEventListener("touchstart",e=>{
    e.preventDefault();
    const r=c.getBoundingClientRect(), t=e.touches[0];
    start(t.clientX-r.left, t.clientY-r.top);
  },{passive:false});
  c.addEventListener("touchmove",e=>{
    e.preventDefault();
    const r=c.getBoundingClientRect(), t=e.touches[0];
    move(t.clientX-r.left, t.clientY-r.top);
  },{passive:false});
  c.addEventListener("touchend",stop);
}
function clearCanvas(id){
  const c=document.getElementById(id), x=c.getContext("2d");
  x.fillStyle="#fff"; x.fillRect(0,0,c.width,c.height);
}
setupCanvas("signRespCanvas");
setupCanvas("signSalCanvas");

/* === Utils === */
function canvasToSmallDataURL(srcCanvas,maxW=360,mime='image/jpeg',quality=0.85){
  const w=srcCanvas.width, h=srcCanvas.height, ratio=Math.min(1,maxW/w);
  const dw=Math.round(w*ratio), dh=Math.round(h*ratio);
  const off=document.createElement('canvas'); off.width=dw; off.height=dh;
  const ctx=off.getContext('2d');
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,dw,dh);
  ctx.drawImage(srcCanvas,0,0,dw,dh);
  return off.toDataURL(mime,quality);
}
function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(String(r.result).split(",")[1]||"");
    r.onerror=reject; r.readAsDataURL(blob);
  });
}

/* === Envoi PDF via proxy === */
async function sendToServer(){
  const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";
  const loader=document.getElementById("loader");
  const btn=document.getElementById("sendBtn");

  try{
    btn.disabled=true; loader.style.display="flex";

    const meta={
      salarie:(document.getElementById("salarie").value||"Inconnu").trim(),
      responsable:(document.getElementById("responsable").value||"N/A").trim(),
      date_fiche:document.getElementById("date_fiche").value||new Date().toISOString().slice(0,10),
    };

    const original=document.getElementById("pageContent");
    const clone=original.cloneNode(true);

    /* Remplace les canvases par images JPEG (fond blanc) dans le clone */
    const respCanvas=document.getElementById("signRespCanvas");
    const salCanvas=document.getElementById("signSalCanvas");
    const imgResp=document.createElement("img");
    imgResp.src=canvasToSmallDataURL(respCanvas,360,"image/jpeg",0.85);
    imgResp.style.width="100%"; imgResp.style.height="auto";
    const imgSal=document.createElement("img");
    imgSal.src=canvasToSmallDataURL(salCanvas,360,"image/jpeg",0.85);
    imgSal.style.width="100%"; imgSal.style.height="auto";

    const cloneResp=clone.querySelector("#signRespCanvas");
    const cloneSal=clone.querySelector("#signSalCanvas");
    if(cloneResp) cloneResp.replaceWith(imgResp);
    if(cloneSal)  cloneSal.replaceWith(imgSal);

    /* Conteneur hors-√©cran pour html2pdf */
    const off=document.createElement("div");
    off.style.position="fixed"; off.style.top="-10000px";
    off.appendChild(clone); document.body.appendChild(off);

    /* Options PDF A4 strictes + pagebreak */
    const opt={
      margin:[10,10],
      filename:`Fiche_Incident_${meta.salarie}_${meta.date_fiche}.pdf`,
      pagebreak:{ mode:['avoid-all'], avoid:['.no-break','.section-b','.signatures','textarea'] },
      html2canvas:{ scale:2, useCORS:true, backgroundColor:"#ffffff", scrollY:0, willReadFrequently:true },
      jsPDF:{ unit:"mm", format:"a4", orientation:"portrait", compress:true },
    };

    const pdfBlob=await html2pdf().set(opt).from(clone).outputPdf("blob");
    off.remove();

    const b64=await blobToBase64(pdfBlob);

    const payload={ meta, b64 };
    const res=await fetch(WEBAPP_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    let ok=false, msg='';
    const ct=res.headers.get("content-type")||"";
    if(ct.includes("application/json")){
      const j=await res.json(); ok=(j.status==="ok"); msg=j.message||"";
    }else{
      const t=await res.text(); ok=res.ok; msg=ok? "OK (non-JSON)" : `HTTP ${res.status} - ${t.slice(0,120)}`;
    }

    if(ok){ alert(`‚úÖ Merci ${meta.responsable},\n\nLa fiche a bien √©t√© enregistr√©e et envoy√©e.`); }
    else  { alert("‚ö†Ô∏è Erreur c√¥t√© serveur : " + msg); }

  }catch(e){
    console.error(e);
    alert("‚ùå Erreur inattendue : " + (e?.message||e));
  }finally{
    loader.style.display="none"; btn.disabled=false;
  }
}
</script>
</body>
</html>
