<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- G√©n√©ration PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous"></script>

<style>
  :root{
    --page-w: 210mm;
    --pad: 14mm;
    --theme: #1a2d4a;
    --txt: #0b1320;
    --bg: #e9ebee;
    --radius: 12px;
    --toolbar-h: 0px;           /* sera mis √† jour en JS */
  }
  *{ box-sizing: border-box; }
  html,body{ margin:0; background:var(--bg); color:var(--txt); font-family: Arial, Helvetica, sans-serif; }

  .page-wrapper{
    display:flex; justify-content:center;
    padding:16px;
    /* espace r√©serv√© en bas = hauteur barre + safe-area + marge */
    padding-bottom: calc(16px + var(--toolbar-h) + env(safe-area-inset-bottom));
  }
  .page{
    width: min(100%, var(--page-w));
    background:#fff; border-radius: var(--radius);
    box-shadow: 0 10px 28px rgba(0,0,0,.10);
    padding: var(--pad);
    display:flex; flex-direction:column; gap:12px;
  }
  .no-break{ break-inside: avoid; page-break-inside: avoid; }

  .header{ display:flex; align-items:center; gap:12px; }
  .header img{ width:54px; height:auto; }
  .header strong{ display:block; font-size:16px; }

  .title{
    border:2px solid #0f1a2d20; border-radius: 10px;
    text-align:center; font-weight:800; letter-spacing:.4px;
    padding:8px 10px; margin-top:2px;
  }

  table.grid{ width:100%; border-collapse: collapse; font-size:14px; table-layout: auto; }
  .grid td{ padding:6px 6px; vertical-align:middle; }
  .label{ font-weight:700; white-space:nowrap; }

  input[type="text"], input[type="date"], textarea{
    width:100%; border:1.5px solid #c9ced6; border-radius:10px; padding:10px 12px; font-size:15px;
  }
  input::placeholder, textarea::placeholder{ color:#9aa3ad; }
  textarea{ min-height:110px; resize:vertical; }

  .section-h{
    background:var(--theme); color:#fff; font-weight:800; letter-spacing:.3px;
    padding:8px 10px; border-radius:10px;
  }
  .section-b{ border:1.5px solid #c9ced6; border-radius:12px; padding:12px; }

  .row{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:8px; }
  .sub{ display:none; gap:8px; align-items:center; }

  .signatures{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .sig-box label{ font-weight:700; display:block; margin-bottom:6px; }
  .sig-wrap{
    position:relative; width:100%; height:140px; border:1.5px dashed #b6bcc6; border-radius:12px; background:#fff;
    touch-action:none;
  }
  canvas.signature{ width:100%; height:140px; display:block; touch-action:none; }
  .sig-hint{ position:absolute; top:8px; right:12px; font-size:12px; color:#7a8592; }

  .sig-actions{ text-align:right; margin-top:6px; }
  .btn-mini{ font-size:13px; padding:7px 12px; border:none; background:#404b57; color:#fff; border-radius:10px; }

  /* Barre d‚Äôoutils */
  .toolbar{ position:fixed; left:0; right:0; bottom:0; z-index:9999; }
  .toolbar-inner{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    background:#fff; border-top:1px solid #00000010; padding:10px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    box-shadow:0 -8px 22px rgba(0,0,0,.06);
  }
  .btn{
    background:#000; color:#fff; border:none; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:15px;
    box-shadow:0 4px 10px rgba(0,0,0,.20);
  }
  .btn.link{ background:transparent; color:#000; border:1.5px dashed #111; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }

  /* Cacher le bouton d‚Äôimpression sur mobile/tablette */
  @media (max-width: 768px), (max-device-width: 768px){
    .btn-print{ display:none !important; }
  }

  #loader{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35);
    z-index:10000; color:#fff; font:600 16px/1.2 Arial, sans-serif;
  }
  #loader .box{ background:#111; padding:14px 18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.4); }

  /* HARMONIE MOBILE (ent√™te en 2 colonnes) */
  @media (max-width: 768px){
    .grid tr { display:block; }
    .grid td { display:block; width:100%; padding:6px 4px; }
    .grid .label{
      margin-bottom:4px;
      white-space: normal;
      line-height:1.25; word-break: break-word;
    }
    .grid tr:first-child{
      display:grid !important;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      column-gap:12px; align-items:end;
    }
    .grid tr:first-child td:nth-child(1),
    .grid tr:first-child td:nth-child(2){ grid-column:1; }
    .grid tr:first-child td:nth-child(3),
    .grid tr:first-child td:nth-child(4){ grid-column:2; }

    .date-actions{ flex-wrap:wrap; gap:6px; }
    input[type="date"]{ min-width:0; }

    input[type="text"], input[type="date"], textarea{
      width:100%; min-height:42px; font-size:15px; padding:10px 12px;
    }
    .signatures{ grid-template-columns: 1fr 1fr; }
  }

  @media print{
    .toolbar{ display:none !important; }
    body{ background:#fff; }
  }
</style>
</head>

<body>
  <!-- Barre d‚Äôoutils -->
  <div class="toolbar no-print" id="toolbar">
    <div class="toolbar-inner">
      <button id="btnPrint" class="btn btn-print" onclick="window.print()">üñ®Ô∏è Imprimer manuellement ordi</button>
      <button id="sendBtn" class="btn" onclick="sendToServer()">üì® Envoyer</button>
      <button id="autoSaveBtn" class="btn link" onclick="toggleAutoSave()">üíæ Sauvegarde auto : ON</button>
      <button class="btn link" onclick="clearAll()">üßπ Effacer tout</button>
    </div>
  </div>

  <div id="loader"><div class="box">‚è≥ G√©n√©ration & envoi en cours‚Ä¶</div></div>

  <!-- Contenu -->
  <div class="page-wrapper">
    <div class="page" id="pageContent">
      <div class="header no-break">
        <img src="logo_otacos.png" alt="O'Tacos">
        <div><strong>HITS BOULOGNE</strong>O‚Äôtacos Boulogne-sur-Mer</div>
      </div>

      <div class="title no-break">FICHE INCIDENTS</div>

      <table class="grid no-break" role="presentation">
        <tr>
          <td class="label">Date :</td>
          <td><div class="date-actions"><input type="date" id="date_fiche" autocomplete="off"></div></td>
          <td class="label" style="text-align:right;">Fiche ouverte pour :</td>
          <td><input type="text" id="salarie" placeholder="Nom du salari√©" autocomplete="name"></td>
        </tr>
        <tr>
          <td class="label">Responsable :</td>
          <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" autocomplete="name"></td>
        </tr>
      </table>

      <div class="section-h no-break">DESCRIPTIF DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <div class="row">
          <input type="checkbox" id="abs_prev"><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
          <div class="sub" id="abs_prev_fields">
            <div class="date-actions"><input type="date" id="abs_prev_date"></div>
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_prev_shift" placeholder="ex: 18h" inputmode="numeric" style="width:100px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="abs_np"><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
          <div class="sub" id="abs_np_fields">
            <div class="date-actions"><input type="date" id="abs_np_date"></div>
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_np_shift" placeholder="ex: 18h" inputmode="numeric" style="width:100px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="ret_prev"><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
          <div class="sub" id="ret_prev_fields">
            <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" inputmode="numeric" style="width:120px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="ret_np"><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
          <div class="sub" id="ret_np_fields">
            <input type="text" id="ret_np_duree" placeholder="ex: 20 min" inputmode="numeric" style="width:120px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="autre"><label for="autre"><strong>Autre :</strong></label>
          <div class="sub" id="autre_fields">
            <input type="text" id="autre_detail" placeholder="Pr√©ciser‚Ä¶" style="min-width:220px; flex:1">
          </div>
        </div>
      </div>

      <div class="section-h no-break">ORIGINE DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <textarea id="origine" placeholder="D√©crire l'origine‚Ä¶"></textarea>
      </div>

      <div class="section-h no-break">ACTION CURATIVE</div>
      <div class="section-b no-break">
        <textarea id="action" placeholder="D√©crire l'action corrective‚Ä¶"></textarea>
      </div>

      <div class="no-break" style="display:flex; align-items:center; gap:8px; font-size:14px;">
        <strong>Fait le :</strong>
        <div class="date-actions"><input type="date" id="fait_le"></div>
        <span>, √† Boulogne-sur-Mer</span>
      </div>

      <div class="signatures no-break">
        <div class="sig-box">
          <label for="signRespCanvas">Signature Responsable</label>
          <div class="sig-wrap">
            <canvas id="signRespCanvas" class="signature"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions"><button class="btn-mini" type="button" onclick="clearCanvas('signRespCanvas'); saveToLocal()">Effacer</button></div>
        </div>
        <div class="sig-box">
          <label for="signSalCanvas">Signature Salari√©</label>
          <div class="sig-wrap">
            <canvas id="signSalCanvas" class="signature"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions"><button class="btn-mini" type="button" onclick="clearCanvas('signSalCanvas'); saveToLocal()">Effacer</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======= Helpers ======= */
const $ = s => document.querySelector(s);
const ALL_FIELDS_SELECTOR = "input[type='text'], input[type='date'], input[type='checkbox'], textarea";

/* UTF-8 Base64 (pour partager l‚Äô√©tat dans l‚ÄôURL) */
const toB64 = s => btoa(unescape(encodeURIComponent(s)));
const fromB64 = b => decodeURIComponent(escape(atob(b)));

function todayStr(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${m}-${day}`;
}

/* ======= Affichage conditionnel ======= */
["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
  const box = document.getElementById(id);
  const sub = document.getElementById(id+"_fields");
  if(!box || !sub) return;
  const sync = ()=>{ sub.style.display = box.checked ? "inline-flex" : "none"; };
  box.addEventListener("change", ()=>{ sync(); saveToLocal(); });
  sync();
});

/* ======= Signatures (HiDPI sans getImageData) ======= */
function setupCanvas(id){
  const c = document.getElementById(id);
  const ctx = c.getContext("2d");

  function fit(){
    let backup = null;
    try{ backup = c.toDataURL("image/png"); }catch(e){}
    const rect = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    c.width  = Math.max(1, Math.round(rect.width * dpr));
    c.height = Math.max(1, Math.round(rect.height * dpr));
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,rect.width,rect.height);
    if(backup){ const img = new Image(); img.onload=()=>ctx.drawImage(img,0,0,rect.width,rect.height); img.src=backup; }
    ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
  }
  function sizeToCss(){
    const p = c.closest('.sig-wrap');
    c.style.width = p.clientWidth + "px";
    c.style.height= p.clientHeight + "px";
  }
  sizeToCss(); fit();
  window.addEventListener("resize", ()=>{ sizeToCss(); fit(); });
  window.addEventListener("orientationchange", ()=>{ setTimeout(()=>{ sizeToCss(); fit(); }, 250); });

  let drawing=false, prev=null; const hint = c.parentElement.querySelector('.sig-hint');
  const start=(x,y)=>{ drawing=true; prev={x,y}; if(hint) hint.style.opacity='0'; };
  const move =(x,y)=>{ if(!drawing) return; ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(x,y); ctx.stroke(); prev={x,y}; saveToLocalThrottled(); };
  const stop =()=>{ drawing=false; prev=null; };

  c.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
  c.addEventListener("mousemove",e=>move(e.offsetX,e.offsetY));
  ["mouseup","mouseleave"].forEach(ev=>c.addEventListener(ev,stop));
  c.addEventListener("touchstart",e=>{ e.preventDefault(); const r=c.getBoundingClientRect(), t=e.touches[0]; start(t.clientX-r.left, t.clientY-r.top); },{passive:false});
  c.addEventListener("touchmove", e=>{ e.preventDefault(); const r=c.getBoundingClientRect(), t=e.touches[0]; move(t.clientX-r.left, t.clientY-r.top); },{passive:false});
  c.addEventListener("touchend", stop);
}
setupCanvas("signRespCanvas");
setupCanvas("signSalCanvas");

function canvasToSmallDataURL(srcCanvas, maxCssW=360, mime='image/jpeg', quality=0.9){
  const rect = srcCanvas.getBoundingClientRect();
  const src  = document.createElement('canvas');
  src.width  = Math.max(1, Math.round(rect.width));
  src.height = Math.max(1, Math.round(rect.height));
  const sctx = src.getContext('2d');
  sctx.fillStyle="#fff"; sctx.fillRect(0,0,src.width,src.height);
  sctx.drawImage(srcCanvas, 0,0, src.width, src.height);

  const ratio = Math.min(1, maxCssW/src.width);
  const dw = Math.round(src.width*ratio), dh=Math.round(src.height*ratio);
  const off = document.createElement('canvas'); off.width=dw; off.height=dh;
  const ctx = off.getContext('2d');
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,dw,dh);
  ctx.drawImage(src, 0,0, dw, dh);
  return off.toDataURL(mime, quality);
}

/* ======= Autosauvegarde + URL partageable ======= */
const STORAGE_KEY = "ficheIncidentBSM";
const STORAGE_OPT_KEY = "ficheIncidentBSM_auto";
function isAutoSaveOn(){ return localStorage.getItem(STORAGE_OPT_KEY)!=="OFF"; }
function setAutoSave(on){
  localStorage.setItem(STORAGE_OPT_KEY, on ? "ON":"OFF");
  const btn = document.getElementById("autoSaveBtn");
  btn.textContent = on ? "üíæ Sauvegarde auto : ON" : "üíæ Sauvegarde auto : OFF";
}
function collectData(includeSigs=true){
  const data = {};
  document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{
    data[el.id] = (el.type==="checkbox") ? el.checked : el.value;
  });
  if(includeSigs){
    data.sign_resp = canvasToSmallDataURL(document.getElementById("signRespCanvas"));
    data.sign_sal  = canvasToSmallDataURL(document.getElementById("signSalCanvas"));
  }
  return data;
}
function applyData(data){
  if(!data) return;
  document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{
    if(!(el.id in data)) return;
    if(el.type==="checkbox") el.checked = !!data[el.id];
    else el.value = data[el.id] || "";
  });
  ["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
    const box=document.getElementById(id), sub=document.getElementById(id+"_fields");
    if(box && sub){ sub.style.display = box.checked ? "inline-flex":"none"; }
  });
  if(data.sign_resp) restoreSignature("signRespCanvas", data.sign_resp);
  if(data.sign_sal)  restoreSignature("signSalCanvas",  data.sign_sal);
}
function restoreSignature(id, dataUrl){
  const c = document.getElementById(id); if(!dataUrl||!c) return;
  const ctx = c.getContext("2d");
  const img = new Image();
  img.onload = ()=>{
    const r = c.getBoundingClientRect();
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,r.width,r.height);
    ctx.drawImage(img, 0,0, r.width, r.height);
    const hint = c.parentElement.querySelector('.sig-hint'); if(hint) hint.style.opacity='0';
  };
  img.src = dataUrl;
}
function updateShareUrl(){
  const data = collectData(false); // sans signatures
  try{
    const b64 = toB64(JSON.stringify(data));
    if(b64.length < 3500){
      const base = location.href.split('#')[0].split('?')[0];
      history.replaceState(null, '', base + '#d=' + b64);
    }
  }catch(e){}
}
function saveToLocal(){
  if(!isAutoSaveOn()) return;
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData(true)));
    updateShareUrl();
    syncToolbarPadding(); // au cas o√π clavier/viewport modifie la hauteur
  }catch(e){}
}
let _saveTimer=null;
function saveToLocalThrottled(){ if(!isAutoSaveOn()) return; clearTimeout(_saveTimer); _saveTimer=setTimeout(saveToLocal, 300); }
function loadFromLocal(){
  const m = location.hash.match(/[#&]d=([^&]+)/);
  if(m && m[1]){ try{ applyData(JSON.parse(fromB64(m[1]))); return; }catch(e){} }
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) applyData(JSON.parse(raw)); }catch(e){}
}
function toggleAutoSave(){ const on=!isAutoSaveOn(); setAutoSave(on); if(on) saveToLocal(); }
function clearAll(){
  if(!confirm("Effacer tous les champs, signatures et la sauvegarde ?")) return;
  document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{ if(el.type==="checkbox") el.checked=false; else el.value=""; });
  ["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{ const sub=document.getElementById(id+"_fields"); if(sub) sub.style.display="none"; });
  clearCanvas("signRespCanvas"); clearCanvas("signSalCanvas");
  localStorage.removeItem(STORAGE_KEY);
  history.replaceState(null,'',location.href.split('#')[0]);
  syncToolbarPadding();
}
function clearCanvas(id){
  const c=document.getElementById(id); const x=c.getContext("2d");
  x.setTransform(1,0,0,1,0,0); x.fillStyle="#fff"; x.fillRect(0,0,c.width,c.height);
  const hint = c.parentElement.querySelector('.sig-hint'); if(hint) hint.style.opacity='1';
}
function bindAutoSaveEvents(){ document.addEventListener("input", saveToLocal); document.addEventListener("change", saveToLocal); }

/* ======= R√©server l‚Äôespace sous la barre (anti-recouvrement) ======= */
function syncToolbarPadding(){
  const tb = document.getElementById('toolbar');
  const h = (tb && getComputedStyle(tb).display!=='none') ? tb.offsetHeight : 0;
  document.documentElement.style.setProperty('--toolbar-h', h + 'px');
}
if(window.visualViewport){
  visualViewport.addEventListener('resize', syncToolbarPadding);
  visualViewport.addEventListener('scroll', syncToolbarPadding);
}

/* ======= Init ======= */
(function init(){
  const def = todayStr();
  ["date_fiche","fait_le"].forEach(id=>{ const el=document.getElementById(id); if(el && !el.value) el.value=def; });
  setAutoSave(isAutoSaveOn());
  bindAutoSaveEvents();
  loadFromLocal();
  updateShareUrl();
  syncToolbarPadding();
  window.addEventListener('resize', syncToolbarPadding);
  window.addEventListener('orientationchange', ()=>setTimeout(syncToolbarPadding, 250));
})();

/* ======= PDF (clone A4, 1 page) ======= */
function prepareCloneForPdf(clone){
  const style = document.createElement('style');
  style.textContent = `
    .pdf-a4{ width:210mm !important; min-height:297mm !important; padding:10mm !important; box-shadow:none !important; border-radius:0 !important; }
    .pdf-a4 .title{ font-size:12.5px; padding:4px 6px; }
    .pdf-a4 .grid{ font-size:11.5px; }
    .pdf-a4 input, .pdf-a4 textarea{ padding:6px 8px; font-size:11.5px; }
    .pdf-a4 textarea{ min-height:60px !important; }
    .pdf-a4 .section-h{ padding:6px 8px; font-size:12px; }
    .pdf-a4 .section-b{ padding:8px; font-size:12px; }
    .pdf-a4 .row{ gap:6px; margin-bottom:6px; }
    .pdf-a4 .sig-wrap{ height:80px !important; }
    .pdf-a4 .signature, .pdf-a4 img.signature-img{ height:80px !important; width:100% !important; object-fit:contain; background:#fff; }
  `;
  clone.prepend(style);
  clone.classList.add('pdf-a4');
}
function replaceCanvasWithImg(clone, canvasId, outHeightPx=80){
  const srcCanvas = document.getElementById(canvasId);
  const img = document.createElement('img');
  img.src = canvasToSmallDataURL(srcCanvas, 500, "image/jpeg", 0.9);
  img.className = "signature-img";
  img.style.width = "100%";
  img.style.height = outHeightPx + "px";
  img.style.objectFit = "contain";
  img.style.background = "#fff";
  const cloneCanvas = clone.querySelector("#"+canvasId);
  if(cloneCanvas) cloneCanvas.replaceWith(img);
}
function fitCloneToOneA4Page(clone){
  const A4_H = 297/25.4*96;      // ‚âà 1123 px
  const M = 10/25.4*96;          // ‚âà 38 px
  const targetH = A4_H - 2*M;
  const h = clone.scrollHeight;
  if(h > targetH){
    const scale = targetH / h;
    clone.style.transformOrigin = "top left";
    clone.style.transform = `scale(${scale})`;
    clone.style.width = `calc(210mm / ${scale})`;
  }
}
function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(String(r.result).split(",")[1]||"");
    r.onerror=reject; r.readAsDataURL(blob);
  });
}

async function sendToServer(){
  const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";
  const loader=$("#loader"), btn=$("#sendBtn");
  try{
    btn.disabled=true; loader.style.display="flex";

    const meta={
      salarie:($("#salarie").value||"Inconnu").trim(),
      responsable:($("#responsable").value||"N/A").trim(),
      date_fiche:$("#date_fiche").value||todayStr(),
    };

    const original=$("#pageContent");
    const clone = original.cloneNode(true);

    prepareCloneForPdf(clone);
    replaceCanvasWithImg(clone, "signRespCanvas", 80);
    replaceCanvasWithImg(clone, "signSalCanvas", 80);

    const off=document.createElement("div");
    off.style.position="fixed"; off.style.top="-10000px"; off.style.left="0";
    off.appendChild(clone); document.body.appendChild(off);

    fitCloneToOneA4Page(clone);

    const opt={
      margin:[10,10],
      filename:`Fiche_Incident_${meta.salarie}_${meta.date_fiche}.pdf`,
      pagebreak:{ mode:['avoid-all'], avoid:['.no-break','.section-b','.signatures','textarea'] },
      html2canvas:{ scale:2, useCORS:true, backgroundColor:"#ffffff", scrollY:0, willReadFrequently:true },
      jsPDF:{ unit:"mm", format:"a4", orientation:"portrait", compress:true },
    };

    const worker = html2pdf().set(opt).from(clone).toPdf();
    await worker.get('pdf');
    const pdfBlob = await worker.output('blob');

    off.remove();

    const b64 = await blobToBase64(pdfBlob);
    const payload={ meta, b64 };

    const res=await fetch(WEBAPP_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });

    let ok=false, msg='';
    const ct=res.headers.get("content-type")||"";
    if(ct.includes("application/json")){ const j=await res.json(); ok=(j.status==="ok"); msg=j.message||""; }
    else{ const t=await res.text(); ok=res.ok; msg=ok? "OK (non-JSON)" : `HTTP ${res.status} - ${t.slice(0,120)}`; }

    alert(ok ? `‚úÖ Merci ${meta.responsable},\n\nLa fiche a bien √©t√© enregistr√©e et envoy√©e.` : "‚ö†Ô∏è Erreur c√¥t√© serveur : " + msg);
    saveToLocal();
  }catch(e){
    console.error(e);
    alert("‚ùå Erreur inattendue : " + (e?.message||e));
  }finally{
    loader.style.display="none"; btn.disabled=false;
  }
}
</script>
</body>
</html>
