<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FICHE INCIDENTS ‚Äî HITS BOULOGNE</title>

<!-- html2pdf (pas d'attribut integrity pour √©viter le blocage SRI) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --blue:#1a2d4a;
    --border:#000;
    --muted:#666;
  }
  html,body{margin:0;font-family:Arial, Helvetica, sans-serif;background:#eee;color:#111}
  .container{max-width:960px;margin:auto;padding:16px}
  .toolbar{
    position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd;
    padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap
  }
  .btn{
    background:#111;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer
  }
  .btn.secondary{background:#3b3b3b}
  .btn.warn{background:#a40}
  .card{background:#fff;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.08);padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  label{font-weight:700;margin:8px 0 4px;display:block}
  input[type="text"],input[type="date"],textarea{
    width:100%;padding:10px;border:1px solid #bbb;border-radius:6px;font-size:16px
  }
  textarea{min-height:80px;resize:vertical}
  .section-title{
    background:var(--blue);color:#fff;padding:8px 10px;border-radius:6px;margin:14px 0 8px;
    font-weight:700;text-transform:uppercase
  }
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .sig-wrap{border:1px dashed #999;border-radius:8px;height:140px;position:relative;background:#fff}
  canvas.signature{width:100%;height:140px;touch-action:none}
  .sig-hint{position:absolute;right:10px;top:6px;font-size:12px;color:#888}
  .sig-actions{text-align:right;margin-top:6px}

  /* === Gabarit A4 pour le PDF === */
  #sheetA4{
    position:fixed;left:-10000px;top:0; /* visible hors √©cran (pas display:none) */
    width:210mm;height:297mm;background:#fff;color:#111;
    box-sizing:border-box;padding:15mm; /* marges internes */
    overflow:hidden; /* emp√™che la 2e page si tout tient */
  }
  .a4-header{display:flex;gap:10px;align-items:flex-start}
  .a4-header img{width:42px;height:auto}
  .a4-title{border:1px solid var(--border);font-weight:700;text-align:center;margin:8px 0 10px;padding:4px}
  .a4-grid{width:100%;border-collapse:collapse;font-size:12pt}
  .a4-grid td{padding:4px 6px;vertical-align:top}
  .a4-label{font-weight:700;white-space:nowrap}
  .bar{background:var(--blue);color:#fff;font-weight:700;text-align:center;padding:4px;text-transform:uppercase;margin:8px 0;border:1px solid #000}
  .box{border:1px solid #000;padding:8px;min-height:24mm}
  .sig-row{display:flex;gap:10mm;margin-top:8mm}
  .sig-box{flex:1}
  .sig-box .sig-slot{border:1px dashed #999;height:30mm}
  .sig-box img{width:100%;height:30mm;object-fit:contain}
  .small{font-size:10pt;color:#333}

  @media (max-width:720px){
    .row,.row-3,.row-4{grid-template-columns:1fr}
    .toolbar{position:sticky}
  }
</style>
</head>
<body>

<div class="toolbar">
  <button class="btn" onclick="makePdf()">üìÑ PDF / Imprimer</button>
  <button class="btn secondary" onclick="sendToServer()">üì® Envoyer</button>
  <button class="btn warn" onclick="clearAll()">üßπ Effacer tout</button>
  <span id="autosaveState" style="margin-left:auto;color:#333;font-weight:600">Sauvegarde auto : ON</span>
</div>

<div class="container">
  <div class="card">

    <div class="section-title">Fiche incidents</div>

    <div class="row-3">
      <div>
        <label for="date_fiche">Date</label>
        <input type="date" id="date_fiche">
      </div>
      <div>
        <label for="salarie">Fiche ouverte pour le salari√©</label>
        <input type="text" id="salarie" placeholder="Nom du salari√©">
      </div>
      <div>
        <label for="responsable">Responsable</label>
        <input type="text" id="responsable" placeholder="Responsable">
      </div>
    </div>

    <div class="section-title">Descriptif de l‚Äôincident</div>

    <div class="row">
      <div>
        <div class="inline">
          <input type="checkbox" id="abs_prev">
          <label for="abs_prev" style="margin:0">Absence pr√©vue le :</label>
        </div>
        <div class="inline" style="margin-top:6px">
          <input type="date" id="abs_prev_date" style="max-width:210px">
          <span class="a4-label">Shift pr√©vu √† :</span>
          <input type="text" id="abs_prev_shift" placeholder="ex : 18h" style="max-width:120px">
        </div>
      </div>
      <div>
        <div class="inline">
          <input type="checkbox" id="abs_np">
          <label for="abs_np" style="margin:0">Absence non pr√©vue le :</label>
        </div>
        <div style="margin-top:6px">
          <input type="date" id="abs_np_date" style="max-width:210px">
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="inline">
          <input type="checkbox" id="ret_prev">
          <label for="ret_prev" style="margin:0">Retard pr√©vu de :</label>
        </div>
        <div style="margin-top:6px">
          <input type="text" id="ret_prev_duree" placeholder="ex : 30 min" style="max-width:210px">
        </div>
      </div>
      <div>
        <div class="inline">
          <input type="checkbox" id="ret_np">
          <label for="ret_np" style="margin:0">Retard non pr√©vu de :</label>
        </div>
        <div style="margin-top:6px">
          <input type="text" id="ret_np_duree" placeholder="ex : 20 min" style="max-width:210px">
        </div>
      </div>
    </div>

    <div class="inline" style="margin-top:8px">
      <input type="checkbox" id="autre">
      <label for="autre" style="margin:0">Autre :</label>
      <input type="text" id="autre_detail" placeholder="Pr√©ciser..." style="flex:1;min-width:240px">
    </div>

    <div class="section-title">Origine de l‚Äôincident</div>
    <textarea id="origine" placeholder="D√©crire l'origine..."></textarea>

    <div class="section-title">Action curative</div>
    <textarea id="action" placeholder="D√©crire l'action corrective..."></textarea>

    <div class="row-3" style="margin-top:8px">
      <div>
        <label for="fait_le">Fait le</label>
        <input type="date" id="fait_le">
      </div>
      <div style="align-self:end"><span class="a4-label small">√† Boulogne-sur-Mer</span></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Signature Responsable</label>
        <div class="sig-wrap">
          <span class="sig-hint">Signez ici</span>
          <canvas id="signResp" class="signature" width="600" height="280"></canvas>
        </div>
        <div class="sig-actions">
          <button class="btn secondary" onclick="clearCanvas('signResp')">Effacer</button>
        </div>
      </div>
      <div>
        <label>Signature Salari√©</label>
        <div class="sig-wrap">
          <span class="sig-hint">Signez ici</span>
          <canvas id="signSal" class="signature" width="600" height="280"></canvas>
        </div>
        <div class="sig-actions">
          <button class="btn secondary" onclick="clearCanvas('signSal')">Effacer</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===================== GABARIT A4 CACH√â (PDF) ===================== -->
<div id="sheetA4" aria-hidden="true">
  <div class="a4-header">
    <img id="logoA4" src="logo_otacos.png" alt="Logo">
    <div>
      <div style="font-weight:700">HITS BOULOGNE</div>
      <div>O‚Äôtacos Boulogne-sur-Mer</div>
    </div>
  </div>

  <div class="a4-title">FICHE INCIDENTS</div>

  <table class="a4-grid">
    <tr>
      <td class="a4-label">Date :</td>
      <td id="p_date">‚Äî</td>
      <td class="a4-label" style="text-align:right">Fiche ouverte pour le salari√© :</td>
      <td id="p_salarie">‚Äî</td>
    </tr>
    <tr>
      <td class="a4-label">Responsable :</td>
      <td colspan="3" id="p_responsable">‚Äî</td>
    </tr>
  </table>

  <div class="bar">Descriptif de l‚Äôincident</div>
  <div class="box small" style="min-height:auto;padding-bottom:4mm">
    <div>‚òê Absence pr√©vue le : <span id="p_abs_prev_date">‚Äî</span>,
      Shift pr√©vu √† : <span id="p_abs_prev_shift">‚Äî</span>
      <span id="tick_abs_prev" style="margin-left:6px;color:var(--muted)"></span>
    </div>
    <div>‚òê Absence non pr√©vue le : <span id="p_abs_np_date">‚Äî</span>
      <span id="tick_abs_np" style="margin-left:6px;color:var(--muted)"></span>
    </div>
    <div>‚òê Retard pr√©vu de : <span id="p_ret_prev">‚Äî</span>
      <span id="tick_ret_prev" style="margin-left:6px;color:var(--muted)"></span>
    </div>
    <div>‚òê Retard non pr√©vu de : <span id="p_ret_np">‚Äî</span>
      <span id="tick_ret_np" style="margin-left:6px;color:var(--muted)"></span>
    </div>
    <div>‚òê Autre : <span id="p_autre">‚Äî</span>
      <span id="tick_autre" style="margin-left:6px;color:var(--muted)"></span>
    </div>
  </div>

  <div class="bar">Origine de l‚Äôincident</div>
  <div class="box" id="p_origine">‚Äî</div>

  <div class="bar">Action curative</div>
  <div class="box" id="p_action">‚Äî</div>

  <div class="small" style="margin-top:6mm">Fait le : <span id="p_fait_le">‚Äî</span>, √† Boulogne-sur-Mer</div>

  <div class="sig-row">
    <div class="sig-box">
      <div class="small" style="font-weight:700;margin-bottom:3mm">Signature Responsable</div>
      <div class="sig-slot"><img id="p_sig_resp" alt=""></div>
    </div>
    <div class="sig-box">
      <div class="small" style="font-weight:700;margin-bottom:3mm">Signature Salari√©</div>
      <div class="sig-slot"><img id="p_sig_sal" alt=""></div>
    </div>
  </div>
</div>
<!-- ================================================================ -->

<script>
/* ========= utilitaires ========= */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);

/* Auto-date par d√©faut (pas de bouton "Aujourd'hui") */
function setDefaultDates(){
  const today = new Date().toISOString().slice(0,10);
  if(!byId('date_fiche').value) byId('date_fiche').value = today;
  if(!byId('fait_le').value) byId('fait_le').value = today;
}
setDefaultDates();

/* Signatures simples */
function setupSignature(id){
  const c = byId(id), ctx = c.getContext('2d');
  // fond blanc pour √©viter les fonds sombres
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
  let drawing=false, prev=null;
  const draw = (x,y) => {
    if(!drawing) return;
    if(!prev) prev = {x,y};
    ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(prev.x, prev.y); ctx.lineTo(x,y); ctx.stroke();
    prev = {x,y};
  };
  c.addEventListener('mousedown',e=>{drawing=true;prev=null;draw(e.offsetX,e.offsetY)});
  c.addEventListener('mousemove',e=>draw(e.offsetX,e.offsetY));
  ['mouseup','mouseleave'].forEach(ev=>c.addEventListener(ev,()=>{drawing=false;prev=null}));
  // tactile
  c.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;prev=null;
    const r=c.getBoundingClientRect(); draw(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top)});
  c.addEventListener('touchmove',e=>{e.preventDefault();
    const r=c.getBoundingClientRect(); draw(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top)});
  c.addEventListener('touchend',()=>{drawing=false;prev=null});
}
function clearCanvas(id){
  const c = byId(id), ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
}
setupSignature('signResp');
setupSignature('signSal');

/* Sauvegarde auto locale */
const STORAGE_KEY="ficheIncidentV2";
function saveLocal(){
  const data={};
  document.querySelectorAll('input,textarea').forEach(el=>{
    data[el.id] = (el.type==='checkbox') ? el.checked : el.value;
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  $('#autosaveState').textContent = 'Sauvegarde auto : ON';
}
function restoreLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  const data = JSON.parse(raw);
  Object.keys(data).forEach(id=>{
    const el = byId(id);
    if(!el) return;
    if(el.type==='checkbox') el.checked = !!data[id];
    else el.value = data[id];
  });
}
function clearAll(){
  document.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(el=>el.value='');
  document.querySelectorAll('input[type="checkbox"]').forEach(el=>el.checked=false);
  clearCanvas('signResp'); clearCanvas('signSal');
  localStorage.removeItem(STORAGE_KEY);
  setDefaultDates();
}
window.addEventListener('input',saveLocal);
window.addEventListener('change',saveLocal);
restoreLocal();

/* ========= Remplir le gabarit A4 et g√©n√©rer le PDF ========= */
function nl2br(str){return String(str||'').replace(/\n/g,'<br>')}

function fillSheet(){
  byId('p_date').textContent = byId('date_fiche').value || '‚Äî';
  byId('p_salarie').textContent = byId('salarie').value || '‚Äî';
  byId('p_responsable').textContent = byId('responsable').value || '‚Äî';

  // cases + ticks
  byId('p_abs_prev_date').textContent = byId('abs_prev_date').value || '‚Äî';
  byId('p_abs_prev_shift').textContent = byId('abs_prev_shift').value || '‚Äî';
  byId('tick_abs_prev').textContent = byId('abs_prev').checked ? '‚òë' : '';

  byId('p_abs_np_date').textContent = byId('abs_np_date').value || '‚Äî';
  byId('tick_abs_np').textContent = byId('abs_np').checked ? '‚òë' : '';

  byId('p_ret_prev').textContent = byId('ret_prev_duree').value || '‚Äî';
  byId('tick_ret_prev').textContent = byId('ret_prev').checked ? '‚òë' : '';

  byId('p_ret_np').textContent = byId('ret_np_duree').value || '‚Äî';
  byId('tick_ret_np').textContent = byId('ret_np').checked ? '‚òë' : '';

  byId('p_autre').textContent = byId('autre_detail').value || '‚Äî';
  byId('tick_autre').textContent = byId('autre').checked ? '‚òë' : '';

  byId('p_origine').innerHTML = nl2br(byId('origine').value||'‚Äî');
  byId('p_action').innerHTML  = nl2br(byId('action').value||'‚Äî');
  byId('p_fait_le').textContent = byId('fait_le').value || '‚Äî';

  // signatures -> images
  byId('p_sig_resp').src = byId('signResp').toDataURL('image/png');
  byId('p_sig_sal').src  = byId('signSal').toDataURL('image/png');
}

async function makePdf(){
  fillSheet();
  // attendre chargement du logo si besoin
  await new Promise(r=>{
    const img = byId('logoA4'); if(img.complete) return r();
    img.addEventListener('load',r,{once:true}); img.addEventListener('error',r,{once:true});
  });

  const el = byId('sheetA4');
  const opt = {
    margin: 0,
    filename: `Fiche_Incident_${(byId('salarie').value||'SansNom').replace(/\s+/g,'_')}_${(byId('date_fiche').value||'SansDate')}.pdf`,
    html2canvas: { scale: 2, useCORS:true, scrollY: 0, backgroundColor:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all'] }
  };
  await html2pdf().set(opt).from(el).save();
}

/* ========= Envoi via proxy Cloudflare (PDF ‚Üí base64) ========= */
async function sendToServer(){
  fillSheet();
  const el = byId('sheetA4');
  const opt = {
    margin: 0,
    html2canvas: { scale: 2, useCORS:true, scrollY: 0, backgroundColor:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  const blob = await html2pdf().set(opt).from(el).outputPdf('blob');
  const buf  = await blob.arrayBuffer();
  const b64  = btoa(String.fromCharCode(...new Uint8Array(buf)));

  const meta = {
    salarie: byId('salarie').value || 'Inconnu',
    responsable: byId('responsable').value || 'N/A',
    date_fiche: byId('date_fiche').value || ''
  };

  try{
    const res = await fetch('https://otacos-proxy.contact-otacosbsm.workers.dev/', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ meta, b64 })
    });
    let msg='OK';
    const ct = res.headers.get('content-type')||'';
    if(ct.includes('application/json')){
      const j = await res.json(); msg = j.message || msg;
      if(j.status!=='ok') throw new Error(msg);
    }else if(!res.ok){
      const t = await res.text(); throw new Error(`HTTP ${res.status} - ${t.slice(0,200)}`);
    }
    alert(`‚úÖ Fiche envoy√©e.\n\n${msg}`);
  }catch(err){
    alert('‚ö†Ô∏è Envoi impossible : '+err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
