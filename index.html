<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  /* ====== √âCRAN (formulaire mobile) ====== */
  :root{
    --brand:#1a2d4a;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:#eceff1; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111 }
  .stage{ display:flex; justify-content:center; padding:14px 10px 92px }
  .sheet{ width:min(100%, 820px); background:#fff; border-radius:12px; box-shadow:0 10px 26px rgba(0,0,0,.15); padding:18px }

  .title{ border:1.5px solid #111; text-align:center; font-weight:800; letter-spacing:.3px; padding:8px; margin:8px 0 12px }
  .bar{ background:var(--brand); color:#fff; font-weight:800; text-transform:uppercase; padding:8px 10px; border-radius:6px 6px 0 0; margin-top:16px }
  .panel{ border:1px solid #111; border-top:none; border-radius:0 0 8px 8px; padding:12px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row-1{ grid-template-columns:1fr }
  label.small{ font-weight:600; font-size:14px }
  input[type="text"],input[type="date"],textarea{ width:100%; border:1px solid #cfd8e3; border-radius:8px; padding:10px 12px; font-size:16px; background:#fff }
  textarea{ min-height:90px; resize:vertical }
  .line{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 }
  .chip{ background:#e9eef5; padding:7px 10px; border-radius:8px; border:1px solid #cfd8e3; font-weight:700; cursor:pointer }
  .sign-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .sign-card{ border:1px dashed #b6c1cf; border-radius:10px; padding:10px; background:#fafbff }
  .sign-wrap{ height:160px; border:1px solid #cdd6e1; border-radius:10px; background:#fff; position:relative; overflow:hidden }
  canvas.signature{ width:100%; height:100%; touch-action:none; display:block }
  .sign-hint{ position:absolute; right:10px; top:8px; color:#8ea0b7; font-size:12px }
  .btn-clear{ margin-top:8px; border:none; background:#f0f3f7; color:#333; border-radius:8px; padding:8px 12px; font-weight:700; cursor:pointer }

  .dock{ position:fixed; left:0; right:0; bottom:0; padding:10px 12px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; background:linear-gradient(180deg,transparent,rgba(255,255,255,.92) 30%,#fff 70%); backdrop-filter:blur(4px) }
  .btn{ border:none; border-radius:12px; padding:12px 18px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(17,38,63,.18) }
  .btn-dark{ background:#111; color:#fff } .btn-blue{ background:#1447ff; color:#fff } .btn-yellow{ background:#f8e7a1; color:#111 }
  .toggle{ display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; background:#f2f6fc; border:1px solid #cfd8e3; font-weight:800 }
  .switch{ width:44px; height:22px; border-radius:20px; background:#c9d7ea; position:relative }
  .switch:before{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:18px; transition:.18s }
  .switch.on{ background:#1fb978 } .switch.on:before{ left:24px }

  #loader{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:9999 }
  #loader .box{ background:#111; color:#fff; padding:16px 20px; border-radius:10px; font-weight:800 }

  @media (max-width:720px){ .row{ grid-template-columns:1fr } .sign-grid{ grid-template-columns:1fr } }
  @media print{ .dock{ display:none!important } }

  /* ====== GABARIT A4 (PDF ‚Äúbureau‚Äù) ====== */
  #printA4{ 
    position:fixed; left:-10000px; top:0; width:210mm; min-height:297mm; 
    background:#fff; padding:15mm; color:#111; font-family: Arial, Helvetica, sans-serif;
  }
  #printA4 .head{ display:flex; align-items:flex-start; gap:10px; }
  #printA4 .head img{ width:48px; height:auto }
  #printA4 .title{ border:1.5px solid #111; text-align:center; font-weight:800; padding:6px; margin:8px 0 12px }
  #printA4 .bar{ background:#1a2d4a; color:#fff; font-weight:800; text-transform:uppercase; padding:6px 8px; border-radius:2px 2px 0 0 }
  #printA4 .panel{ border:1px solid #111; border-top:none; padding:8px }
  #printA4 table{ width:100%; border-collapse:collapse; }
  #printA4 td{ border:1px solid #111; padding:6px; vertical-align:top; }
  #printA4 .lbl{ width:180px; font-weight:bold; background:#f6f8fc }
  #printA4 .sign-box{ height:130px; border:1px solid #111; }
  #printA4 .muted{ color:#555 }
  /* √©vite les coupures sur PDF */
  #printA4 .avoid{ page-break-inside: avoid; break-inside: avoid; }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader"><div class="box">‚è≥ G√©n√©ration‚Ä¶</div></div>

<!-- ========= FORMULAIRE (√©cran/mobile) ========= -->
<div class="stage">
  <div id="a4" class="sheet">
    <div style="display:flex; align-items:center; gap:10px">
      <img src="logo_otacos.png" alt="logo" style="width:54px">
      <div style="font-weight:800; line-height:1.15">
        HITS BOULOGNE<br><span style="font-weight:600; opacity:.8">O‚Äôtacos Boulogne-sur-Mer</span>
      </div>
    </div>

    <div class="title">FICHE INCIDENTS</div>

    <div class="row">
      <div>
        <label class="small">Date :</label>
        <div class="line">
          <input type="date" id="date_fiche"><button class="chip" type="button" id="btnTodayTop">Aujourd‚Äôhui</button>
        </div>
      </div>
      <div>
        <label class="small">Fiche ouverte pour le salari√© :</label>
        <input type="text" id="salarie" placeholder="Nom du salari√©">
      </div>
    </div>

    <div class="row-1" style="margin-top:10px">
      <label class="small">Responsable :</label>
      <input type="text" id="responsable" placeholder="Responsable">
    </div>

    <div class="bar">DESCRIPTIF DE L‚ÄôINCIDENT</div>
    <div class="panel">
      <div class="line">
        <input type="checkbox" id="abs_prev"><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
        <input type="date" id="abs_prev_date"><button class="chip" type="button" id="btnPrevToday">Aujourd‚Äôhui</button>
        <span>Shift pr√©vu √† :</span><input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:90px">
      </div>
      <div class="line">
        <input type="checkbox" id="abs_np"><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
        <input type="date" id="abs_np_date">
      </div>
      <div class="line">
        <input type="checkbox" id="ret_prev"><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
        <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:110px">
      </div>
      <div class="line">
        <input type="checkbox" id="ret_np"><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
        <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:110px">
      </div>
      <div class="line">
        <input type="checkbox" id="autre"><label for="autre"><strong>Autre :</strong></label>
        <input type="text" id="autre_detail" placeholder="Pr√©ciser‚Ä¶" style="flex:1; min-width:180px">
      </div>
    </div>

    <div class="bar">ORIGINE DE L‚ÄôINCIDENT</div>
    <div class="panel"><textarea id="origine" placeholder="D√©crire l‚Äôorigine‚Ä¶"></textarea></div>

    <div class="bar">ACTION CURATIVE</div>
    <div class="panel"><textarea id="action" placeholder="D√©crire l‚Äôaction corrective‚Ä¶"></textarea></div>

    <div class="line" style="margin-top:12px">
      <label class="small">Fait le :</label>
      <input type="date" id="fait_le" style="max-width:170px"><button class="chip" type="button" id="btnTodayFait">Aujourd‚Äôhui</button>
      <span>, √† Boulogne-sur-Mer</span>
    </div>

    <div class="sign-grid" style="margin-top:10px">
      <div class="sign-card">
        <div class="small" style="font-weight:800">Signature Responsable</div>
        <div class="sign-wrap"><canvas id="signRespCanvas" class="signature" width="800" height="240"></canvas><div class="sign-hint">Signez ici</div></div>
        <button class="btn-clear" type="button" data-clear="signRespCanvas">Effacer</button>
      </div>
      <div class="sign-card">
        <div class="small" style="font-weight:800">Signature Salari√©</div>
        <div class="sign-wrap"><canvas id="signSalCanvas" class="signature" width="800" height="240"></canvas><div class="sign-hint">Signez ici</div></div>
        <button class="btn-clear" type="button" data-clear="signSalCanvas">Effacer</button>
      </div>
    </div>
  </div>
</div>

<!-- ========= GABARIT A4 CACH√â POUR LE PDF ========= -->
<div id="printA4">
  <div class="head">
    <img src="logo_otacos.png" alt="logo">
    <div><div style="font-weight:800">HITS BOULOGNE</div><div class="muted">O‚Äôtacos Boulogne-sur-Mer</div></div>
  </div>
  <div class="title">FICHE INCIDENTS</div>

  <table style="margin-bottom:8px">
    <tr>
      <td class="lbl">Date :</td>
      <td><span id="p_date"></span></td>
      <td class="lbl">Fiche ouverte pour le salari√© :</td>
      <td><span id="p_salarie"></span></td>
    </tr>
    <tr>
      <td class="lbl">Responsable :</td>
      <td colspan="3"><span id="p_responsable"></span></td>
    </tr>
  </table>

  <div class="bar">DESCRIPTIF DE L‚ÄôINCIDENT</div>
  <div class="panel avoid">
    <table>
      <tr>
        <td class="lbl">Absence pr√©vue le :</td>
        <td>
          <span id="p_abs_prev_chk">‚ñ°</span>
          <span id="p_abs_prev_date"></span>
          &nbsp;&nbsp;Shift pr√©vu √† : <span id="p_abs_prev_shift"></span>
        </td>
      </tr>
      <tr>
        <td class="lbl">Absence non pr√©vue le :</td>
        <td><span id="p_abs_np_chk">‚ñ°</span> <span id="p_abs_np_date"></span></td>
      </tr>
      <tr>
        <td class="lbl">Retard pr√©vu de :</td>
        <td><span id="p_ret_prev_chk">‚ñ°</span> <span id="p_ret_prev_duree"></span></td>
      </tr>
      <tr>
        <td class="lbl">Retard non pr√©vu de :</td>
        <td><span id="p_ret_np_chk">‚ñ°</span> <span id="p_ret_np_duree"></span></td>
      </tr>
      <tr>
        <td class="lbl">Autre :</td>
        <td><span id="p_autre_chk">‚ñ°</span> <span id="p_autre_detail"></span></td>
      </tr>
    </table>
  </div>

  <div class="bar">ORIGINE DE L‚ÄôINCIDENT</div>
  <div class="panel avoid"><div id="p_origine"></div></div>

  <div class="bar">ACTION CURATIVE</div>
  <div class="panel avoid"><div id="p_action"></div></div>

  <table style="margin-top:8px">
    <tr>
      <td class="lbl">Fait le :</td>
      <td><span id="p_fait_le"></span>, √† Boulogne-sur-Mer</td>
    </tr>
  </table>

  <table style="margin-top:10px">
    <tr>
      <td class="lbl">Signature Responsable</td>
      <td class="lbl">Signature Salari√©</td>
    </tr>
    <tr>
      <td class="sign-box"><img id="p_sign_resp" style="width:100%; height:130px; object-fit:contain"></td>
      <td class="sign-box"><img id="p_sign_sal"  style="width:100%; height:130px; object-fit:contain"></td>
    </tr>
  </table>
</div>

<!-- ========= BOUTONS FIXES ========= -->
<div class="dock">
  <button class="btn btn-dark" id="btnPDF">üßæ PDF / Imprimer</button>
  <button class="btn btn-blue" id="btnSend">‚úâÔ∏è Envoyer</button>

  <div id="autoSaveToggle" class="toggle">
    <div id="asSwitch" class="switch on"></div>
    Sauvegarde auto : <span id="asState">ON</span>
  </div>

  <button class="btn btn-yellow" id="btnClearAll">üßπ Effacer tout</button>
</div>

<script>
/* ============ Utilitaires & champs ============ */
const $ = s => document.querySelector(s);
const $all = s => document.querySelectorAll(s);
const setToday = el => el.value = new Date().toISOString().slice(0,10);

const ids = ["date_fiche","salarie","responsable","abs_prev","abs_prev_date","abs_prev_shift","abs_np","abs_np_date","ret_prev","ret_prev_duree","ret_np","ret_np_duree","autre","autre_detail","origine","action","fait_le"];

/* ============ Signatures (fond blanc) ============ */
function setupSignature(id){
  const c = document.getElementById(id), ctx = c.getContext("2d", { willReadFrequently:true });
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.lineCap="round";
  let d=false;
  const pos=e=>{ const r=c.getBoundingClientRect(); const t=e.touches?.[0]; return t?{x:t.clientX-r.left,y:t.clientY-r.top}:{x:e.offsetX,y:e.offsetY}; };
  const down=e=>{ d=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
  const move=e=>{ if(!d)return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
  const up=e=>{ d=false; e.preventDefault(); };
  c.addEventListener("mousedown",down); c.addEventListener("mousemove",move); c.addEventListener("mouseup",up); c.addEventListener("mouseleave",up);
  c.addEventListener("touchstart",down,{passive:false}); c.addEventListener("touchmove",move,{passive:false}); c.addEventListener("touchend",up);
}
setupSignature("signRespCanvas");
setupSignature("signSalCanvas");
$all(".btn-clear").forEach(b=>b.onclick=()=>{
  const id=b.dataset.clear, c=document.getElementById(id), ctx=c.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
});

/* ============ Sauvegarde auto ============ */
const LSKEY="ficheIncidentV3"; let autoSave=true;
function saveLocal(){
  if(!autoSave) return;
  const d={};
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    d[id]=(el.type==="checkbox")?el.checked:el.value;
  });
  d.signResp=$("#signRespCanvas").toDataURL("image/jpeg",.9);
  d.signSal=$("#signSalCanvas").toDataURL("image/jpeg",.9);
  localStorage.setItem(LSKEY,JSON.stringify(d));
}
function loadLocal(){
  const r=localStorage.getItem(LSKEY); if(!r) return;
  try{
    const d=JSON.parse(r);
    ids.forEach(id=>{
      const el=document.getElementById(id); if(!el||!(id in d)) return;
      if(el.type==="checkbox") el.checked=!!d[id]; else el.value=d[id];
    });
    const back=(id,dat)=>{ if(!dat) return; const c=document.getElementById(id),ctx=c.getContext("2d"); ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height); const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,c.width,c.height); img.src=dat; };
    back("signRespCanvas",d.signResp); back("signSalCanvas",d.signSal);
  }catch(e){}
}
function clearAll(){
  ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==="checkbox") el.checked=false; else el.value=""; });
  setToday($("#date_fiche")); setToday($("#fait_le"));
  ["signRespCanvas","signSalCanvas"].forEach(id=>{const c=document.getElementById(id),ctx=c.getContext("2d"); ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);});
  localStorage.removeItem(LSKEY);
}
loadLocal();
window.addEventListener("input",saveLocal);
window.addEventListener("change",saveLocal);
$("#autoSaveToggle").onclick=()=>{ autoSave=!autoSave; $("#asSwitch").classList.toggle("on",autoSave); $("#asState").textContent=autoSave?"ON":"OFF"; if(autoSave) saveLocal(); };

/* Raccourcis dates */
$("#btnTodayTop").onclick=()=>setToday($("#date_fiche"));
$("#btnPrevToday").onclick=()=>setToday($("#abs_prev_date"));
$("#btnTodayFait").onclick=()=>setToday($("#fait_le"));
if(!$("#date_fiche").value) setToday($("#date_fiche"));
if(!$("#fait_le").value) setToday($("#fait_le"));

/* ============ Gabarit PDF : alimentation ============ */
function canvasToJPEGDataURL(c, maxW=1200, q=.95){
  const s=Math.min(1,maxW/c.width), w=Math.round(c.width*s), h=Math.round(c.height*s);
  const off=document.createElement("canvas"); off.width=w; off.height=h;
  const x=off.getContext("2d");
  x.fillStyle="#fff"; x.fillRect(0,0,w,h);
  x.drawImage(c,0,0,w,h);
  return off.toDataURL("image/jpeg",q);
}
function fillPrintTemplate(){
  // champs texte/dates
  $("#p_date").textContent = $("#date_fiche").value || "";
  $("#p_salarie").textContent = $("#salarie").value || "";
  $("#p_responsable").textContent = $("#responsable").value || "";
  $("#p_abs_prev_date").textContent = $("#abs_prev_date").value || "";
  $("#p_abs_prev_shift").textContent = $("#abs_prev_shift").value || "";
  $("#p_abs_np_date").textContent = $("#abs_np_date").value || "";
  $("#p_ret_prev_duree").textContent = $("#ret_prev_duree").value || "";
  $("#p_ret_np_duree").textContent = $("#ret_np_duree").value || "";
  $("#p_autre_detail").textContent = $("#autre_detail").value || "";
  $("#p_origine").textContent = $("#origine").value || "";
  $("#p_action").textContent = $("#action").value || "";
  $("#p_fait_le").textContent = $("#fait_le").value || $("#date_fiche").value || "";

  // cases coch√©es
  $("#p_abs_prev_chk").textContent = $("#abs_prev").checked ? "‚òëÔ∏é" : "‚ñ°";
  $("#p_abs_np_chk").textContent   = $("#abs_np").checked ? "‚òëÔ∏é"   : "‚ñ°";
  $("#p_ret_prev_chk").textContent = $("#ret_prev").checked ? "‚òëÔ∏é" : "‚ñ°";
  $("#p_ret_np_chk").textContent   = $("#ret_np").checked ? "‚òëÔ∏é"   : "‚ñ°";
  $("#p_autre_chk").textContent    = $("#autre").checked ? "‚òëÔ∏é"    : "‚ñ°";

  // signatures
  $("#p_sign_resp").src = canvasToJPEGDataURL($("#signRespCanvas"));
  $("#p_sign_sal").src  = canvasToJPEGDataURL($("#signSalCanvas"));
}

/* ============ PDF (√† partir du gabarit cach√©) ============ */
async function buildPdfBlobFromTemplate(){
  fillPrintTemplate(); // injecte les valeurs dans #printA4
  const node = document.getElementById("printA4");
  const opt = {
    margin:0,
    filename:`Fiche_Incident_${($("#salarie").value||"SansNom")}_${($("#date_fiche").value||"SansDate")}.pdf`,
    html2canvas:{ scale:2, useCORS:true, scrollY:0, windowWidth: node.scrollWidth, letterRendering:true },
    jsPDF:{ unit:"mm", format:"a4", orientation:"portrait" },
    pagebreak:{ mode:['css','avoid-all'] }
  };
  const blob = await html2pdf().set(opt).from(node).outputPdf("blob");
  return blob;
}

/* ============ Envoi via proxy (inchang√©) ============ */
const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";
async function sendToServer(){
  try{
    $("#loader").style.display="grid";
    const b=await buildPdfBlobFromTemplate();
    const buf=await b.arrayBuffer();
    const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));
    const meta={ salarie:$("#salarie").value||"Inconnu", responsable:$("#responsable").value||"N/A", date_fiche:$("#date_fiche").value||new Date().toISOString().slice(0,10) };
    const res=await fetch(WEBAPP_URL,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({meta,b64}) });
    const ct=res.headers.get("content-type")||""; let ok=false,msg="";
    if(ct.includes("application/json")){ const j=await res.json(); ok=j.status==="ok"; msg=j.message||""; } else { ok=res.ok; msg=ok?"OK":`HTTP ${res.status}`; }
    alert(ok?`‚úÖ Merci ${meta.responsable}, la fiche a √©t√© envoy√©e.`:`‚ö†Ô∏è Erreur d'envoi : ${msg}`);
  }catch(e){ alert("‚ö†Ô∏è Erreur : "+e.message); }
  finally{ $("#loader").style.display="none"; }
}

/* ============ Boutons ============ */
$("#btnPDF").onclick = async ()=>{
  try{
    $("#loader").style.display="grid";
    const blob=await buildPdfBlobFromTemplate();
    const url=URL.createObjectURL(blob);
    const w=window.open(url,"_blank"); if(!w) alert("PDF g√©n√©r√©. Autorise les popups pour l‚Äôaper√ßu.");
  }catch(e){ alert("‚ö†Ô∏è Erreur PDF : "+e.message); }
  finally{ $("#loader").style.display="none"; }
};
$("#btnSend").onclick = sendToServer;
$("#btnClearAll").onclick = ()=>{ if(confirm("Effacer tous les champs + signatures ?")) clearAll(); };
</script>
</body>
</html>
