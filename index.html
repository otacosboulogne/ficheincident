<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>
<style>
  html, body {
    margin: 0;
    background: #dcdcdc;
    font-family: Arial, sans-serif;
  }

  .page-wrapper {
    display: flex;
    justify-content: center;
    padding: 16px;
  }

  .page {
    width: 210mm;
    min-height: 297mm;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    padding: 15mm;
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: relative;
  }

  .header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .header img {
    width: 40px;
  }

  .header-text strong {
    display: block;
    font-size: 14px;
  }

  .fiche-title {
    border: 1px solid #000;
    font-weight: bold;
    text-align: center;
    padding: 4px;
    text-transform: uppercase;
    margin-top: 8px;
    font-size: 15px;
  }

  .info-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .info-table td {
    padding: 4px;
    vertical-align: middle;
  }

  .label {
    font-weight: bold;
    white-space: nowrap;
  }

  input, textarea {
    border: 1px solid #999;
    border-radius: 3px;
    padding: 4px;
    font-size: 13px;
    max-width: 100%;
  }

  .section-header {
    background: #1a2d4a;
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 4px;
    text-transform: uppercase;
    font-size: 13px;
    border: 1px solid #000;
    border-bottom: none;
  }

  .section-body {
    border: 1px solid #000;
    border-top: none;
    padding: 8px;
    font-size: 13px;
  }

  .incident-line {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 6px;
    align-items: center;
  }

  .big-textarea {
    width: 100%;
    min-height: 70px;
    resize: vertical;
  }

  .signatures {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .signature-box {
    flex: 1;
    min-width: 45%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .signature-box label {
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 13px;
    align-self: flex-start;
  }

  .signature-wrapper {
    width: 100%;
    border: 1px solid #000;
    border-radius: 4px;
    height: 120px;
    position: relative;
    background: #fff;
  }

  canvas.signature-canvas {
    width: 100%;
    height: 120px;
    touch-action: none;
  }

  .signature-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 4px;
    width: 100%;
  }

  .signature-actions button {
    border: none;
    background: #444;
    color: white;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
  }

  .top-buttons {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .action-btn {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 14px;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  @media print {
    body { background: #fff; }
    .page-wrapper { padding: 0; }
    .page {
      box-shadow: none;
      margin: 0;
      width: 210mm;
      min-height: 297mm;
      padding: 15mm;
    }
    .top-buttons { display: none !important; }
  }
</style>
</head>
<body>

<div class="top-buttons">
  <button class="action-btn" onclick="window.print()">📄 PDF / Imprimer</button>
  <button class="action-btn" onclick="sendToServer()">📨 Envoyer</button>
</div>

<div class="page-wrapper">
  <div class="page" id="pageContent">

    <div class="header">
      <img src="logo_otacos.png" alt="O'Tacos Logo" />
      <div class="header-text">
        <strong>HITS BOULOGNE</strong>
        O’tacos Boulogne-sur-Mer
      </div>
    </div>

    <div class="fiche-title">FICHE INCIDENTS</div>

    <table class="info-table">
      <tr>
        <td class="label">Date :</td>
        <td><input type="date" id="date_fiche" /></td>
        <td class="label" style="text-align:right;">Fiche ouverte pour le salarié :</td>
        <td><input type="text" id="salarie" placeholder="Nom du salarié" /></td>
      </tr>
      <tr>
        <td class="label">Responsable :</td>
        <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" style="width:60%;" /></td>
      </tr>
    </table>

    <div class="section-header">DESCRIPTIF DE L’INCIDENT</div>
    <div class="section-body">
      <div class="incident-line"><input type="checkbox" id="abs_prev" /><label for="abs_prev"><strong>Absence prévue le :</strong></label>
        <div class="sub-fields" id="abs_prev_fields" style="display:none;">
          <input type="date" id="abs_prev_date" /> Shift prévu à : <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="abs_np" /><label for="abs_np"><strong>Absence non prévue le :</strong></label>
        <div class="sub-fields" id="abs_np_fields" style="display:none;">
          <input type="date" id="abs_np_date" /> Shift prévu à : <input type="text" id="abs_np_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="ret_prev" /><label for="ret_prev"><strong>Retard prévu de :</strong></label>
        <div class="sub-fields" id="ret_prev_fields" style="display:none;">
          <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="ret_np" /><label for="ret_np"><strong>Retard non prévu de :</strong></label>
        <div class="sub-fields" id="ret_np_fields" style="display:none;">
          <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="autre" /><label for="autre"><strong>Autre :</strong></label>
        <div class="sub-fields" id="autre_fields" style="display:none;">
          <input type="text" id="autre_detail" placeholder="Préciser..." style="flex:1; min-width:200px;" />
        </div>
      </div>
    </div>

    <div class="section-header">ORIGINE DE L’INCIDENT</div>
    <div class="section-body"><textarea class="big-textarea" id="origine" placeholder="Décrire l'origine..."></textarea></div>

    <div class="section-header">ACTION CURATIVE</div>
    <div class="section-body"><textarea class="big-textarea" id="action" placeholder="Décrire l'action corrective..."></textarea></div>

    <div style="margin-top:10px; font-size:14px;">
      <strong>Fait le :</strong> <input type="date" id="fait_le" style="font-size:13px;" />, à Boulogne-sur-Mer
    </div>

    <div class="signatures">
      <div class="signature-box">
        <label for="signRespCanvas">Signature Responsable</label>
        <div class="signature-wrapper"><canvas id="signRespCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signRespCanvas')">Effacer</button></div>
      </div>
      <div class="signature-box">
        <label for="signSalCanvas">Signature Salarié</label>
        <div class="signature-wrapper"><canvas id="signSalCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signSalCanvas')">Effacer</button></div>
      </div>
    </div>

  </div>
</div>
<script>
/* === Affichage conditionnel des champs === */
const boxes = ["abs_prev","abs_np","ret_prev","ret_np","autre"];
boxes.forEach(id=>{
  const box = document.getElementById(id);
  box.addEventListener("change",()=>{
    const sub = document.getElementById(id+"_fields");
    sub.style.display = box.checked ? "inline-flex" : "none";
    saveToLocal();
  });
});

/* === Signatures === */
function setupCanvas(id){
  const c=document.getElementById(id),x=c.getContext("2d");
  let d=false;
  c.addEventListener("mousedown",e=>{d=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY)});
  c.addEventListener("mousemove",e=>{if(!d)return;x.lineTo(e.offsetX,e.offsetY);x.stroke()});
  ["mouseup","mouseleave"].forEach(ev=>c.addEventListener(ev,()=>d=false));
  c.addEventListener("touchstart",e=>{
    d=true;
    const r=c.getBoundingClientRect();
    x.beginPath();
    x.moveTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);
  },{passive:false});
  c.addEventListener("touchmove",e=>{
    if(!d)return;
    const r=c.getBoundingClientRect();
    x.lineTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);
    x.stroke();
  },{passive:false});
  c.addEventListener("touchend",()=>d=false);
}
function clearCanvas(id){
  const c=document.getElementById(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
  saveToLocal();
}
setupCanvas("signRespCanvas");
setupCanvas("signSalCanvas");

/* === Sauvegarde locale === */
function saveToLocal(){
  const d={};
  document.querySelectorAll("input,textarea").forEach(e=>d[e.id]=e.type=="checkbox"?e.checked:e.value);
  d.signResp=document.getElementById("signRespCanvas").toDataURL();
  d.signSal=document.getElementById("signSalCanvas").toDataURL();
  localStorage.setItem("ficheIncident",JSON.stringify(d));
}
function loadFromLocal(){
  const r=localStorage.getItem("ficheIncident");
  if(!r)return;
  const d=JSON.parse(r);
  Object.keys(d).forEach(k=>{
    const e=document.getElementById(k);
    if(e){if(e.type=="checkbox")e.checked=d[k];else e.value=d[k];}
  });
  restore("signRespCanvas",d.signResp);
  restore("signSalCanvas",d.signSal);
  boxes.forEach(id=>{
    const sub=document.getElementById(id+"_fields");
    sub.style.display=document.getElementById(id).checked?"inline-flex":"none";
  });
}
function restore(id,img){
  if(!img)return;
  const c=document.getElementById(id),x=c.getContext("2d"),i=new Image();
  i.onload=()=>x.drawImage(i,0,0,c.width,c.height);
  i.src=img;
}
window.addEventListener("input",saveToLocal);
window.addEventListener("change",saveToLocal);
loadFromLocal();

/* === Envoi Google Script === */
async function sendToServer(){
  const WEBAPP_URL="https://script.google.com/macros/s/AKfycbzRcVl64_GbD16MKbA_xnnvIvq1TjoE835oBaLUnnE3w4Z_cravuV4LkcWX72m321rs/exec";
  const data={};
  document.querySelectorAll("input,textarea").forEach(e=>{
    data[e.id]=e.type=="checkbox"?e.checked:e.value;
  });
  data.signature_responsable_png=document.getElementById("signRespCanvas").toDataURL();
  data.signature_salarie_png=document.getElementById("signSalCanvas").toDataURL();
  data.generatedFileName=`Fiche_Incident_${data.salarie||"SansNom"}_${data.date_fiche||"SansDate"}.pdf`;
  data.html=document.getElementById("pageContent").outerHTML;

  const btns=document.querySelectorAll(".action-btn");
  btns.forEach(b=>b.disabled=true);

  try {
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    const responsable=data.responsable||"le responsable";
    alert(`✅ Merci ${responsable},\n\nLa fiche d’incident sera imprimée et envoyée par mail dans quelques instants.`);
  } catch (err) {
    console.error(err);
    alert("⚠️ Une erreur est survenue lors de l'envoi. Vérifiez votre connexion Internet.");
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}
</script>
</body>
</html>
