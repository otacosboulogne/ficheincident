<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- html2pdf (charg√© depuis cdnjs, sans SRI pour √©viter le blocage iOS) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --a4w: 794px;   /* 210mm @96dpi ‚âà 794 */
    --a4h: 1123px;  /* 297mm @96dpi ‚âà 1123 */
    --pad: 18px;
    --brand: #11263f;
  }
  *{ box-sizing: border-box; }
  html, body{
    margin:0; padding:0;
    background:#eceff1;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
  }

  /* Stage = zone centr√©e (√©cran) */
  .stage{
    display:flex; justify-content:center;
    padding: 14px 10px 90px; /* place pour les boutons fixes */
  }

  /* Feuille A4 (√©cran) */
  .sheet{
    width: min(100%, var(--a4w));          /* s‚Äôadapte au mobile mais reste ‚Äúcalibr√©e‚Äù */
    min-height: var(--a4h);
    background:#fff;
    border-radius:10px;
    box-shadow: 0 10px 26px rgba(0,0,0,.15);
    padding: clamp(12px, 2.6vw, var(--pad));
    position: relative;
  }

  /* Rubriques / style */
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .row-1{ grid-template-columns: 1fr; }
  label.small{ font-weight:600; font-size:14px; color:#111; }
  input[type="text"], input[type="date"], textarea{
    width:100%;
    border:1px solid #cdd6e1;
    border-radius:8px;
    padding:10px 12px;
    font-size:16px;
    background:#fff;
  }
  textarea{ min-height: 90px; resize: vertical; }

  .title{
    border:1.5px solid #111; text-align:center;
    font-weight:800; letter-spacing:.5px;
    padding:8px; margin: 6px 0 10px;
  }
  .bar{
    background: var(--brand);
    color:#fff; font-weight:800; text-transform:uppercase;
    padding:7px 10px; border-radius:6px 6px 0 0; margin-top:18px;
  }
  .panel{
    border:1px solid #111; border-top:none;
    padding: 12px; border-radius: 0 0 8px 8px;
  }

  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .chip{ background:#e9eef5; padding:7px 10px; border-radius:8px; font-weight:600; cursor:pointer; border:1px solid #cfd8e3; }
  .chip:active{ transform: scale(.98); }

  .line{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:8px 0; }
  .line input[type="checkbox"]{ transform: scale(1.3); }

  /* Signatures */
  .sign-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .sign-card{
    border:1px dashed #b6c1cf; border-radius:10px; padding: 10px;
    background:#fafbff;
  }
  .sign-title{ font-weight:700; margin-bottom:6px; }
  .sign-wrap{
    width:100%; height:160px; background:#fff; border:1px solid #cdd6e1;
    border-radius:10px; position:relative; overflow:hidden;
  }
  canvas.signature{ width:100%; height:100%; touch-action: none; display:block; }
  .sign-hint{ position:absolute; right:12px; top:8px; color:#8ea0b7; font-size:12px; }

  .btn-clear{
    margin-top:8px; border:none; background:#f0f3f7; color:#333; border-radius:8px; padding:8px 12px; font-weight:700; cursor:pointer;
  }

  /* Boutons fixes */
  .dock{
    position: fixed; left:0; right:0; bottom:0;
    padding:10px 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    background: linear-gradient(180deg, transparent, rgba(255,255,255,.92) 30%, #fff 70%);
    backdrop-filter: blur(4px);
  }
  .btn{
    border:none; border-radius:12px; padding:12px 18px;
    font-weight:800; letter-spacing:.2px; cursor:pointer;
    box-shadow: 0 6px 18px rgba(17,38,63,.18);
    display:flex; align-items:center; gap:10px;
  }
  .btn-dark{ background:#111; color:#fff; }
  .btn-blue{ background:#1447ff; color:#fff; }
  .btn-yellow{ background:#f8e7a1; color:#111; }

  .toggle{
    display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
    background:#f2f6fc; border:1px solid #cfd8e3; font-weight:800;
  }
  .switch{
    width:44px; height:22px; border-radius:20px; background:#c9d7ea; position:relative;
  }
  .switch:before{
    content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:18px; transition:.18s;
  }
  .switch.on{ background:#1fb978; }
  .switch.on:before{ left:24px; }

  /* Loader */
  #loader{ position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.35); z-index: 9999; }
  #loader .box{ background: #111; color:#fff; padding:16px 20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.4); font-weight:800; }

  /* Eviter les sauts dans le PDF */
  .avoid-break{ page-break-inside: avoid; break-inside: avoid; }

  @media (max-width: 720px){
    .row{ grid-template-columns: 1fr; }
    .sign-grid{ grid-template-columns: 1fr; }
  }

  /* Impression / PDF */
  @media print{
    body{ background:#fff; }
    .stage{ padding:0; }
    .sheet{ width:210mm; min-height:297mm; border-radius:0; box-shadow:none; padding: 15mm; }
    .dock{ display:none !important; }
  }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader"><div class="box">‚è≥ G√©n√©ration & envoi‚Ä¶</div></div>

<!-- CONTENU -->
<div class="stage">
  <div id="a4" class="sheet">
    <div class="row-1">
      <div style="display:flex; align-items:center; gap:10px;">
        <img src="logo_otacos.png" alt="logo" style="width:54px; height:auto;">
        <div style="font-weight:800; line-height:1.15">
          HITS BOULOGNE<br><span style="font-weight:600; opacity:.8">O‚Äôtacos Boulogne-sur-Mer</span>
        </div>
      </div>
    </div>

    <div class="title">FICHE INCIDENTS</div>

    <div class="row">
      <div>
        <label class="small">Date :</label>
        <div class="flex">
          <input type="date" id="date_fiche">
          <button class="chip" type="button" id="btnTodayTop">Aujourd‚Äôhui</button>
        </div>
      </div>
      <div>
        <label class="small">Fiche ouverte pour le salari√© :</label>
        <input type="text" id="salarie" placeholder="Nom du salari√©">
      </div>
    </div>

    <div class="row-1" style="margin-top:10px">
      <label class="small">Responsable :</label>
      <input type="text" id="responsable" placeholder="Responsable">
    </div>

    <!-- DESCRIPTIF -->
    <div class="bar">DESCRIPTIF DE L‚ÄôINCIDENT</div>
    <div class="panel avoid-break">
      <div class="line">
        <input type="checkbox" id="abs_prev">
        <label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
        <input type="date" id="abs_prev_date">
        <button class="chip" type="button" id="btnPrevToday">Aujourd‚Äôhui</button>
        <span>Shift pr√©vu √† :</span>
        <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:90px">
      </div>

      <div class="line">
        <input type="checkbox" id="abs_np">
        <label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
        <input type="date" id="abs_np_date">
      </div>

      <div class="line">
        <input type="checkbox" id="ret_prev">
        <label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
        <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:110px">
      </div>

      <div class="line">
        <input type="checkbox" id="ret_np">
        <label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
        <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:110px">
      </div>

      <div class="line">
        <input type="checkbox" id="autre">
        <label for="autre"><strong>Autre :</strong></label>
        <input type="text" id="autre_detail" placeholder="Pr√©ciser‚Ä¶" style="flex:1; min-width:180px">
      </div>
    </div>

    <!-- ORIGINE -->
    <div class="bar">ORIGINE DE L‚ÄôINCIDENT</div>
    <div class="panel">
      <textarea id="origine" placeholder="D√©crire l‚Äôorigine‚Ä¶"></textarea>
    </div>

    <!-- ACTION -->
    <div class="bar">ACTION CURATIVE</div>
    <div class="panel">
      <textarea id="action" placeholder="D√©crire l‚Äôaction corrective‚Ä¶"></textarea>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="flex">
        <label class="small">Fait le :</label>
        <input type="date" id="fait_le" style="max-width:170px">
        <button class="chip" type="button" id="btnTodayFait">Aujourd‚Äôhui</button>
        <span>, √† Boulogne-sur-Mer</span>
      </div>
    </div>

    <!-- SIGNATURES -->
    <div class="sign-grid avoid-break" style="margin-top:10px">
      <div class="sign-card">
        <div class="sign-title">Signature Responsable</div>
        <div class="sign-wrap">
          <canvas id="signRespCanvas" class="signature" width="600" height="190"></canvas>
          <div class="sign-hint">Signez ici</div>
        </div>
        <button class="btn-clear" type="button" data-clear="signRespCanvas">Effacer</button>
      </div>

      <div class="sign-card">
        <div class="sign-title">Signature Salari√©</div>
        <div class="sign-wrap">
          <canvas id="signSalCanvas" class="signature" width="600" height="190"></canvas>
          <div class="sign-hint">Signez ici</div>
        </div>
        <button class="btn-clear" type="button" data-clear="signSalCanvas">Effacer</button>
      </div>
    </div>
  </div>
</div>

<!-- BOUTONS FIXES -->
<div class="dock">
  <button class="btn btn-dark" id="btnPDF">üßæ PDF / Imprimer</button>
  <button class="btn btn-blue" id="btnSend">‚úâÔ∏è Envoyer</button>

  <div id="autoSaveToggle" class="toggle">
    <div id="asSwitch" class="switch on"></div>
    Sauvegarde auto : <span id="asState">ON</span>
  </div>

  <button class="btn btn-yellow" id="btnClearAll">üßπ Effacer tout</button>
</div>

<script>
/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
const $all = s => document.querySelectorAll(s);
const setToday = inp => inp.value = new Date().toISOString().slice(0,10);

/* ====== Champs & listeners ====== */
const inputsToSave = [
  "date_fiche","salarie","responsable",
  "abs_prev","abs_prev_date","abs_prev_shift",
  "abs_np","abs_np_date",
  "ret_prev","ret_prev_duree",
  "ret_np","ret_np_duree",
  "autre","autre_detail",
  "origine","action","fait_le"
];

/* ====== Signatures ====== */
function setupSignature(canvasId){
  const c = document.getElementById(canvasId);
  const ctx = c.getContext('2d', { willReadFrequently:true });
  let drawing = false;

  // fond blanc (√©vite rectangles noirs en PDF)
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2; ctx.lineCap = "round";

  const pos = e => {
    const r = c.getBoundingClientRect();
    if (e.touches && e.touches[0]){
      return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
    }
    return { x: e.offsetX, y: e.offsetY };
  };

  const down = e => { drawing = true; const p = pos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); };
  const move = e => { if (!drawing) return; const p = pos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
  const up   = e => { drawing = false; e.preventDefault(); };

  c.addEventListener("mousedown", down);
  c.addEventListener("mousemove", move);
  c.addEventListener("mouseup", up);
  c.addEventListener("mouseleave", up);
  c.addEventListener("touchstart", down, {passive:false});
  c.addEventListener("touchmove", move, {passive:false});
  c.addEventListener("touchend", up);
}
setupSignature("signRespCanvas");
setupSignature("signSalCanvas");

$all(".btn-clear").forEach(b=>{
  b.addEventListener("click", ()=>{
    const id = b.getAttribute("data-clear");
    const c = document.getElementById(id);
    const ctx = c.getContext("2d");
    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,c.width,c.height);
  });
});

/* ====== Sauvegarde auto ====== */
const LSKEY = "ficheIncidentV2";
let autoSave = true;
function saveLocal(){
  if (!autoSave) return;
  const d = {};
  inputsToSave.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    d[id] = (el.type === "checkbox") ? el.checked : el.value;
  });
  d.signResp = document.getElementById("signRespCanvas").toDataURL("image/jpeg", .85);
  d.signSal  = document.getElementById("signSalCanvas").toDataURL("image/jpeg", .85);
  localStorage.setItem(LSKEY, JSON.stringify(d));
}
function loadLocal(){
  const r = localStorage.getItem(LSKEY);
  if (!r) return;
  try{
    const d = JSON.parse(r);
    inputsToSave.forEach(id=>{
      const el = document.getElementById(id);
      if (!el || !(id in d)) return;
      if (el.type === "checkbox") el.checked = !!d[id];
      else el.value = d[id];
    });
    const drawBack = (id, data) => {
      if (!data) return;
      const c = document.getElementById(id);
      const ctx = c.getContext("2d");
      ctx.fillStyle = "#fff"; ctx.fillRect(0,0,c.width,c.height);
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img, 0, 0, c.width, c.height);
      img.src = data;
    };
    drawBack("signRespCanvas", d.signResp);
    drawBack("signSalCanvas", d.signSal);
  }catch(e){}
}
function clearAll(){
  inputsToSave.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    if (el.type === "checkbox") el.checked = false;
    else el.value = "";
  });
  // date du jour & ‚Äúfait le‚Äù
  setToday($("#date_fiche"));
  setToday($("#fait_le"));
  // signatures -> blanc
  ["signRespCanvas","signSalCanvas"].forEach(id=>{
    const c = document.getElementById(id), ctx = c.getContext("2d");
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
  });
  localStorage.removeItem(LSKEY);
}
loadLocal();
window.addEventListener("input", saveLocal);
window.addEventListener("change", saveLocal);

/* Toggle auto-save */
const asSwitch = $("#asSwitch"), asState = $("#asState");
$("#autoSaveToggle").addEventListener("click", ()=>{
  autoSave = !autoSave;
  asSwitch.classList.toggle("on", autoSave);
  asState.textContent = autoSave ? "ON" : "OFF";
  if (autoSave) saveLocal();
});

/* Raccourcis ‚ÄúAujourd‚Äôhui‚Äù */
$("#btnTodayTop").onclick = ()=> setToday($("#date_fiche"));
$("#btnPrevToday").onclick = ()=> setToday($("#abs_prev_date"));
$("#btnTodayFait").onclick = ()=> setToday($("#fait_le"));
if (!$("#date_fiche").value) setToday($("#date_fiche"));
if (!$("#fait_le").value) setToday($("#fait_le"));

/* ====== PDF (A4 propre) ====== */
function canvasToJPEGDataURL(srcCanvas, maxW = 600, quality = .9){
  const scale = Math.min(1, maxW / srcCanvas.width);
  const w = Math.round(srcCanvas.width * scale);
  const h = Math.round(srcCanvas.height * scale);
  const off = document.createElement("canvas");
  off.width = w; off.height = h;
  const x = off.getContext("2d");
  x.fillStyle = "#fff"; x.fillRect(0,0,w,h);          // fond blanc
  x.drawImage(srcCanvas, 0, 0, w, h);
  return off.toDataURL("image/jpeg", quality);
}
async function buildPdfBlob(){
  // Clone ‚Äúpropre‚Äù
  const original = document.getElementById("a4");
  const clone = original.cloneNode(true);

  // Remplacer les canvases par images
  const origResp = document.getElementById("signRespCanvas");
  const origSal  = document.getElementById("signSalCanvas");
  const respData = canvasToJPEGDataURL(origResp, 900, .95);
  const salData  = canvasToJPEGDataURL(origSal, 900, .95);

  const cResp = clone.querySelector("#signRespCanvas");
  const cSal  = clone.querySelector("#signSalCanvas");
  if (cResp){ const img = new Image(); img.src = respData; img.style.width="100%"; img.style.height="auto"; cResp.replaceWith(img); }
  if (cSal){  const img = new Image(); img.src = salData;  img.style.width="100%"; img.style.height="auto"; cSal.replaceWith(img); }

  // Container ‚Äúhors √©cran‚Äù calibr√© A4 pour html2pdf
  const host = document.createElement("div");
  host.style.position="fixed"; host.style.left="-10000px"; host.style.top="0";
  // s‚Äôassurer de la largeur A4 exacte pour html2canvas
  clone.style.width = "210mm";
  clone.style.minHeight = "297mm";
  clone.style.boxShadow = "none";
  clone.style.borderRadius = "0";
  clone.style.padding = "15mm";
  host.appendChild(clone);
  document.body.appendChild(host);

  // Options html2pdf ‚Üí A4 portrait, pas de 2e page
  const opt = {
    margin:       0,
    filename:     `Fiche_Incident_${($("#salarie").value||"SansNom")}_${($("#date_fiche").value||"SansDate")}.pdf`,
    html2canvas:  { scale: 2, useCORS: true, scrollY: 0, windowWidth: clone.scrollWidth, letterRendering: true },
    jsPDF:        { unit:"mm", format:"a4", orientation:"portrait" },
    pagebreak:    { mode:['css','avoid-all'] }
  };

  // G√©n√©rer
  const blob = await html2pdf().set(opt).from(clone).outputPdf("blob");
  host.remove();
  return blob;
}

/* ====== Envoi via CF Worker (comme avant) ====== */
const WEBAPP_URL = "https://otacos-proxy.contact-otacosbsm.workers.dev/";

async function sendToServer(){
  try{
    $("#loader").style.display = "grid";
    const b = await buildPdfBlob();
    const buf = await b.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const meta = {
      salarie: $("#salarie").value || "Inconnu",
      responsable: $("#responsable").value || "N/A",
      date_fiche: $("#date_fiche").value || new Date().toISOString().slice(0,10),
    };
    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ meta, b64 })
    });
    const ct = res.headers.get("content-type") || "";
    let ok=false, msg="";
    if (ct.includes("application/json")){
      const j = await res.json(); ok = j.status==="ok"; msg = j.message||"";
    } else {
      ok = res.ok; msg = ok ? "OK" : `HTTP ${res.status}`;
    }
    alert(ok ? `‚úÖ Merci ${meta.responsable}, la fiche a √©t√© envoy√©e.` : `‚ö†Ô∏è Erreur d'envoi : ${msg}`);
  }catch(e){
    alert("‚ö†Ô∏è Erreur : " + e.message);
  }finally{
    $("#loader").style.display = "none";
  }
}

/* ====== Actions boutons ====== */
$("#btnPDF").addEventListener("click", async ()=>{
  try{
    $("#loader").style.display = "grid";
    const blob = await buildPdfBlob();
    // ouvrir en impression
    const url = URL.createObjectURL(blob);
    const win = window.open(url, "_blank");
    if (!win) alert("PDF g√©n√©r√©. Autorisez les popups pour l‚Äôaper√ßu.");
  }catch(e){
    alert("‚ö†Ô∏è Erreur PDF : " + e.message);
  }finally{
    $("#loader").style.display = "none";
  }
});
$("#btnSend").addEventListener("click", sendToServer);
$("#btnClearAll").addEventListener("click", ()=>{
  if (confirm("Effacer tous les champs + signatures ?")) clearAll();
});
</script>
</body>
</html>
