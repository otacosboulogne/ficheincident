<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- Librairie pour générer le PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  html, body {
    margin: 0;
    background: #dcdcdc;
    font-family: Arial, sans-serif;
  }

  .page-wrapper {
    display: flex;
    justify-content: center;
    padding: 16px;
  }

  .page {
    width: 210mm;
    min-height: 297mm;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    padding: 15mm;
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: relative;
  }

  .header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .header img {
    width: 50px;
  }

  .header-text strong {
    display: block;
    font-size: 15px;
  }

  .fiche-title {
    border: 1px solid #000;
    font-weight: bold;
    text-align: center;
    padding: 4px;
    text-transform: uppercase;
    margin-top: 8px;
    font-size: 15px;
  }

  .info-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .info-table td {
    padding: 4px;
    vertical-align: middle;
  }

  .label {
    font-weight: bold;
    white-space: nowrap;
  }

  input, textarea {
    border: 1px solid #999;
    border-radius: 3px;
    padding: 4px;
    font-size: 13px;
    max-width: 100%;
  }

  .section-header {
    background: #1a2d4a;
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 4px;
    text-transform: uppercase;
    font-size: 13px;
    border: 1px solid #000;
    border-bottom: none;
  }

  .section-body {
    border: 1px solid #000;
    border-top: none;
    padding: 8px;
    font-size: 13px;
  }

  .incident-line {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 6px;
    align-items: center;
  }

  .big-textarea {
    width: 100%;
    min-height: 70px;
    resize: vertical;
  }

  .signatures {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .signature-box {
    flex: 1;
    min-width: 45%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .signature-box label {
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 13px;
    align-self: flex-start;
  }

  .signature-wrapper {
    width: 100%;
    border: 1px solid #000;
    border-radius: 4px;
    height: 120px;
    position: relative;
    background: #fff;
  }

  canvas.signature-canvas {
    width: 100%;
    height: 120px;
    touch-action: none;
  }

  .signature-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 4px;
    width: 100%;
  }

  .signature-actions button {
    border: none;
    background: #444;
    color: white;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
  }

  .top-buttons {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .action-btn {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 14px;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  @media print {
    body { background: #fff; }
    .page-wrapper { padding: 0; }
    .page {
      box-shadow: none;
      margin: 0;
      width: 210mm;
      min-height: 297mm;
      padding: 15mm;
    }
    .top-buttons { display: none !important; }
  }
</style>
</head>

<body>
<div class="top-buttons">
  <button class="action-btn" onclick="window.print()">📄 PDF / Imprimer</button>
  <button class="action-btn" onclick="sendToServer()">📨 Envoyer</button>
</div>

<div class="page-wrapper">
  <div class="page" id="pageContent">

    <div class="header">
      <img src="logo_otacos.png" alt="O'Tacos Logo" />
      <div class="header-text">
        <strong>HITS BOULOGNE</strong>
        O’tacos Boulogne-sur-Mer
      </div>
    </div>

    <div class="fiche-title">FICHE INCIDENTS</div>

    <table class="info-table">
      <tr>
        <td class="label">Date :</td>
        <td><input type="date" id="date_fiche" /></td>
        <td class="label" style="text-align:right;">Fiche ouverte pour le salarié :</td>
        <td><input type="text" id="salarie" placeholder="Nom du salarié" /></td>
      </tr>
      <tr>
        <td class="label">Responsable :</td>
        <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" style="width:60%;" /></td>
      </tr>
    </table>

    <div class="section-header">DESCRIPTIF DE L’INCIDENT</div>
    <div class="section-body">
      <div class="incident-line"><input type="checkbox" id="abs_prev" /><label for="abs_prev"><strong>Absence prévue le :</strong></label>
        <div class="sub-fields" id="abs_prev_fields" style="display:none;">
          <input type="date" id="abs_prev_date" /> Shift prévu à : <input type="text" id="abs_prev_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="abs_np" /><label for="abs_np"><strong>Absence non prévue le :</strong></label>
        <div class="sub-fields" id="abs_np_fields" style="display:none;">
          <input type="date" id="abs_np_date" /> Shift prévu à : <input type="text" id="abs_np_shift" placeholder="ex: 18h" style="width:70px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="ret_prev" /><label for="ret_prev"><strong>Retard prévu de :</strong></label>
        <div class="sub-fields" id="ret_prev_fields" style="display:none;">
          <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="ret_np" /><label for="ret_np"><strong>Retard non prévu de :</strong></label>
        <div class="sub-fields" id="ret_np_fields" style="display:none;">
          <input type="text" id="ret_np_duree" placeholder="ex: 20 min" style="width:90px;" />
        </div>
      </div>

      <div class="incident-line"><input type="checkbox" id="autre" /><label for="autre"><strong>Autre :</strong></label>
        <div class="sub-fields" id="autre_fields" style="display:none;">
          <input type="text" id="autre_detail" placeholder="Préciser..." style="flex:1; min-width:200px;" />
        </div>
      </div>
    </div>

    <div class="section-header">ORIGINE DE L’INCIDENT</div>
    <div class="section-body"><textarea class="big-textarea" id="origine" placeholder="Décrire l'origine..."></textarea></div>

    <div class="section-header">ACTION CURATIVE</div>
    <div class="section-body"><textarea class="big-textarea" id="action" placeholder="Décrire l'action corrective..."></textarea></div>

    <div style="margin-top:10px; font-size:14px;">
      <strong>Fait le :</strong> <input type="date" id="fait_le" style="font-size:13px;" />, à Boulogne-sur-Mer
    </div>

    <div class="signatures">
      <div class="signature-box">
        <label for="signRespCanvas">Signature Responsable</label>
        <div class="signature-wrapper"><canvas id="signRespCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signRespCanvas')">Effacer</button></div>
      </div>
      <div class="signature-box">
        <label for="signSalCanvas">Signature Salarié</label>
        <div class="signature-wrapper"><canvas id="signSalCanvas" class="signature-canvas" width="400" height="120"></canvas></div>
        <div class="signature-actions"><button type="button" onclick="clearCanvas('signSalCanvas')">Effacer</button></div>
      </div>
    </div>

  </div>
</div>

<script>
/* === Gestion des sous-champs conditionnels === */
const boxes=["abs_prev","abs_np","ret_prev","ret_np","autre"];
boxes.forEach(id=>{
  const box=document.getElementById(id);
  box.addEventListener("change",()=>{
    const sub=document.getElementById(id+"_fields");
    sub.style.display=box.checked?"inline-flex":"none";
  });
});

/* === Gestion des signatures === */
function setupCanvas(id){
  const c=document.getElementById(id),x=c.getContext("2d");let d=false;
  c.addEventListener("mousedown",e=>{d=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY)});
  c.addEventListener("mousemove",e=>{if(!d)return;x.lineTo(e.offsetX,e.offsetY);x.stroke()});
  ["mouseup","mouseleave"].forEach(ev=>c.addEventListener(ev,()=>d=false));
  c.addEventListener("touchstart",e=>{d=true;const r=c.getBoundingClientRect();x.beginPath();x.moveTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top)},{passive:false});
  c.addEventListener("touchmove",e=>{if(!d)return;const r=c.getBoundingClientRect();x.lineTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);x.stroke()},{passive:false});
  c.addEventListener("touchend",()=>d=false);
}
function clearCanvas(id){const c=document.getElementById(id);c.getContext("2d").clearRect(0,0,c.width,c.height);}
setupCanvas("signRespCanvas");
setupCanvas("signSalCanvas");

/* === ENVOI DU PDF === */
async function sendToServer(){
  const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";

  const meta={
    salarie:document.getElementById("salarie").value||"Inconnu",
    responsable:document.getElementById("responsable").value||"N/A",
    date_fiche:document.getElementById("date_fiche").value||new Date().toISOString().split("T")[0]
  };

  // Génération du PDF base64
  const element=document.getElementById("pageContent");
  const pdfBlob=await html2pdf().from(element).outputPdf("blob");
  const buffer=await pdfBlob.arrayBuffer();
  const b64=btoa(String.fromCharCode(...new Uint8Array(buffer)));

  const payload={meta,b64};

  try{
    const res=await fetch(WEBAPP_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const json=await res.json();
    if(json.status==="ok"){
      alert(`✅ Merci ${meta.responsable},\n\nLa fiche d’incident a été envoyée, imprimée et enregistrée avec succès !`);
    }else{
      alert("⚠️ Erreur : "+json.message);
    }
  }catch(err){
    alert("⚠️ Erreur d'envoi : "+err.message);
  }
}
</script>
</body>
</html>
