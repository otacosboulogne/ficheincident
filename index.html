<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>FICHE INCIDENTS ‚Äî HITS BOULOGNE</title>

<!-- G√©n√©ration PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --blue:#1a2d4a; --border:#000; --muted:#666;
  }
  html,body{margin:0;background:#eef1f4;color:#111;font-family:Arial,Helvetica,sans-serif}

  /* Barre d‚Äôactions */
  .toolbar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #dcdfe3;
    padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:11px 16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.08)}
  .btn.dark{background:#111;color:#fff}
  .btn.blue{background:#1447ff;color:#fff}
  .btn.warn{background:#d79f2a;color:#111}

  .container{max-width:960px;margin:auto;padding:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:16px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid1{display:grid;grid-template-columns:1fr;gap:12px}
  @media (max-width:720px){ .grid2,.grid3{grid-template-columns:1fr} }

  label{font-weight:700;margin:8px 0 4px;display:block}
  input[type="text"],input[type="date"],textarea{
    width:100%;border:1px solid #cfd6de;border-radius:10px;padding:10px 12px;font-size:16px;background:#fff
  }
  textarea{min-height:90px;resize:vertical}

  .section{margin-top:14px}
  .section .bar{background:var(--blue);color:#fff;font-weight:800;text-transform:uppercase;border-radius:8px 8px 0 0;padding:8px 12px}
  .section .panel{border:1px solid #000;border-top:none;border-radius:0 0 10px 10px;padding:12px}

  .line{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0}
  .line input[type="checkbox"]{transform:scale(1.2)}

  /* Signatures */
  .sig-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
  @media (max-width:720px){ .sig-grid{grid-template-columns:1fr} }
  .sig-card{border:1px dashed #b9c5d4;background:#fafcff;border-radius:10px;padding:10px}
  .sig-wrap{height:150px;border:1px solid #cfd6de;border-radius:10px;background:#fff;position:relative;overflow:hidden}
  canvas.signature{width:100%;height:100%;touch-action:none;display:block}
  .sig-hint{position:absolute;right:10px;top:6px;font-size:12px;color:#8fa0b6}
  .sig-actions{text-align:right;margin-top:6px}

  /* ==== GABARIT A4 (pour PDF) ==== */
  #sheetA4{
    position:fixed;left:-10000px;top:0; /* hors √©cran mais pr√©sent dans le DOM */
    width:210mm;min-height:297mm;background:#fff;color:#111;box-sizing:border-box;padding:15mm;overflow:hidden;
    font-family:Arial,Helvetica,sans-serif;
  }
  #sheetA4 .header{display:flex;gap:10px;align-items:flex-start}
  #sheetA4 .header img{width:46px;height:auto}
  #sheetA4 .title{border:1px solid var(--border);font-weight:800;text-align:center;margin:8px 0 10px;padding:6px}
  #sheetA4 .grid{width:100%;border-collapse:collapse}
  #sheetA4 td{padding:6px 8px;vertical-align:top;font-size:12pt}
  #sheetA4 .lbl{font-weight:700;white-space:nowrap}
  #sheetA4 .bar{background:var(--blue);color:#fff;font-weight:800;text-transform:uppercase;text-align:center;padding:6px;border:1px solid #000;margin:8px 0 0}
  #sheetA4 .box{border:1px solid #000;border-top:none;padding:10px;font-size:12pt}
  #sheetA4 .sig-row{display:flex;gap:12mm;margin-top:10mm}
  #sheetA4 .sig-box{flex:1}
  #sheetA4 .sig-slot{border:1px dashed #999;height:33mm}
  #sheetA4 .sig-slot img{width:100%;height:33mm;object-fit:contain}
  #sheetA4 .muted{color:#555}
  #sheetA4 .avoid{page-break-inside:avoid;break-inside:avoid}
</style>
</head>
<body>

<!-- Barre d‚Äôactions -->
<div class="toolbar">
  <button class="btn dark" onclick="makePdf()">üìÑ PDF / Imprimer</button>
  <button class="btn blue" onclick="sendToServer()">üì® Envoyer</button>
  <button class="btn warn" onclick="clearAll()">üßπ Effacer tout</button>
</div>

<!-- Formulaire (mobile / bureau) -->
<div class="container">
  <div class="card">

    <div class="grid1">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="logo_otacos.png" alt="logo" style="width:54px;height:auto">
        <div style="font-weight:800;line-height:1.15">
          HITS BOULOGNE<br><span style="font-weight:600;opacity:.8">O‚Äôtacos Boulogne-sur-Mer</span>
        </div>
      </div>
    </div>

    <div class="section" style="margin-top:10px">
      <div class="bar">Fiche incidents</div>
      <div class="panel">
        <div class="grid3">
          <div>
            <label for="date_fiche">Date</label>
            <input type="date" id="date_fiche">
          </div>
          <div>
            <label for="salarie">Fiche ouverte pour le salari√©</label>
            <input type="text" id="salarie" placeholder="Nom du salari√©">
          </div>
          <div>
            <label for="responsable">Responsable</label>
            <input type="text" id="responsable" placeholder="Responsable">
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="bar">Descriptif de l‚Äôincident</div>
      <div class="panel">
        <div class="line">
          <input type="checkbox" id="abs_prev">
          <label for="abs_prev" style="margin:0"><strong>Absence pr√©vue le :</strong></label>
          <input type="date" id="abs_prev_date" style="max-width:220px">
          <span class="lbl">Shift pr√©vu √† :</span><input type="text" id="abs_prev_shift" placeholder="ex : 18h" style="max-width:110px">
        </div>
        <div class="line">
          <input type="checkbox" id="abs_np">
          <label for="abs_np" style="margin:0"><strong>Absence non pr√©vue le :</strong></label>
          <input type="date" id="abs_np_date" style="max-width:220px">
        </div>
        <div class="line">
          <input type="checkbox" id="ret_prev">
          <label for="ret_prev" style="margin:0"><strong>Retard pr√©vu de :</strong></label>
          <input type="text" id="ret_prev_duree" placeholder="ex : 30 min" style="max-width:140px">
        </div>
        <div class="line">
          <input type="checkbox" id="ret_np">
          <label for="ret_np" style="margin:0"><strong>Retard non pr√©vu de :</strong></label>
          <input type="text" id="ret_np_duree" placeholder="ex : 20 min" style="max-width:140px">
        </div>
        <div class="line">
          <input type="checkbox" id="autre">
          <label for="autre" style="margin:0"><strong>Autre :</strong></label>
          <input type="text" id="autre_detail" placeholder="Pr√©ciser..." style="flex:1;min-width:220px">
        </div>
      </div>
    </div>

    <div class="section">
      <div class="bar">Origine de l‚Äôincident</div>
      <div class="panel"><textarea id="origine" placeholder="D√©crire l‚Äôorigine‚Ä¶"></textarea></div>
    </div>

    <div class="section">
      <div class="bar">Action curative</div>
      <div class="panel"><textarea id="action" placeholder="D√©crire l‚Äôaction corrective‚Ä¶"></textarea></div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label for="fait_le">Fait le</label>
        <input type="date" id="fait_le">
      </div>
      <div style="display:flex;align-items:flex-end"><span class="lbl" style="font-weight:700">√† Boulogne-sur-Mer</span></div>
    </div>

    <div class="sig-grid">
      <div class="sig-card">
        <div style="font-weight:800;margin-bottom:6px">Signature Responsable</div>
        <div class="sig-wrap">
          <span class="sig-hint">Signez ici</span>
          <canvas id="signResp" class="signature" width="800" height="300"></canvas>
        </div>
        <div class="sig-actions"><button class="btn" onclick="clearCanvas('signResp')">Effacer</button></div>
      </div>
      <div class="sig-card">
        <div style="font-weight:800;margin-bottom:6px">Signature Salari√©</div>
        <div class="sig-wrap">
          <span class="sig-hint">Signez ici</span>
          <canvas id="signSal" class="signature" width="800" height="300"></canvas>
        </div>
        <div class="sig-actions"><button class="btn" onclick="clearCanvas('signSal')">Effacer</button></div>
      </div>
    </div>

  </div>
</div>

<!-- ===== GABARIT A4 CACH√â (PDF) ===== -->
<div id="sheetA4" aria-hidden="true">
  <div class="header">
    <img id="logoA4" src="logo_otacos.png" alt="Logo">
    <div>
      <div style="font-weight:800">HITS BOULOGNE</div>
      <div class="muted">O‚Äôtacos Boulogne-sur-Mer</div>
    </div>
  </div>

  <div class="title">FICHE INCIDENTS</div>

  <table class="grid">
    <tr>
      <td class="lbl">Date :</td>
      <td id="p_date">‚Äî</td>
      <td class="lbl" style="text-align:right">Fiche ouverte pour le salari√© :</td>
      <td id="p_salarie">‚Äî</td>
    </tr>
    <tr>
      <td class="lbl">Responsable :</td>
      <td colspan="3" id="p_responsable">‚Äî</td>
    </tr>
  </table>

  <div class="bar">Descriptif de l‚Äôincident</div>
  <div class="box avoid" style="padding-bottom:6mm">
    <div>‚òê Absence pr√©vue le : <span id="p_abs_prev_date">‚Äî</span>, Shift pr√©vu √† : <span id="p_abs_prev_shift">‚Äî</span> <span id="tick_abs_prev" style="margin-left:6px;color:var(--muted)"></span></div>
    <div>‚òê Absence non pr√©vue le : <span id="p_abs_np_date">‚Äî</span> <span id="tick_abs_np" style="margin-left:6px;color:var(--muted)"></span></div>
    <div>‚òê Retard pr√©vu de : <span id="p_ret_prev">‚Äî</span> <span id="tick_ret_prev" style="margin-left:6px;color:var(--muted)"></span></div>
    <div>‚òê Retard non pr√©vu de : <span id="p_ret_np">‚Äî</span> <span id="tick_ret_np" style="margin-left:6px;color:var(--muted)"></span></div>
    <div>‚òê Autre : <span id="p_autre">‚Äî</span> <span id="tick_autre" style="margin-left:6px;color:var(--muted)"></span></div>
  </div>

  <div class="bar">Origine de l‚Äôincident</div>
  <div class="box avoid" id="p_origine">‚Äî</div>

  <div class="bar">Action curative</div>
  <div class="box avoid" id="p_action">‚Äî</div>

  <div style="margin-top:10mm">Fait le : <span id="p_fait_le">‚Äî</span>, √† Boulogne-sur-Mer</div>

  <div class="sig-row">
    <div class="sig-box">
      <div style="font-weight:700;margin-bottom:3mm">Signature Responsable</div>
      <div class="sig-slot"><img id="p_sig_resp" alt=""></div>
    </div>
    <div class="sig-box">
      <div style="font-weight:700;margin-bottom:3mm">Signature Salari√©</div>
      <div class="sig-slot"><img id="p_sig_sal" alt=""></div>
    </div>
  </div>
</div>

<script>
/* ====== utils ====== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const nl2br = s => String(s||'').replace(/\n/g,'<br>');

/* Signatures : fond blanc pour √©viter noirs en PDF */
function setupSignature(id){
  const c = byId(id), ctx = c.getContext('2d', { willReadFrequently:true });
  ctx.fillStyle = "#fff"; ctx.fillRect(0,0,c.width,c.height);
  let drawing=false, last=null;
  const pos = e=>{
    const r=c.getBoundingClientRect();
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top};
    return {x:e.offsetX, y:e.offsetY};
  };
  const down=e=>{ drawing=true; last=null; const p=pos(e); draw(p.x,p.y); e.preventDefault(); };
  const move=e=>{ if(!drawing) return; const p=pos(e); draw(p.x,p.y); e.preventDefault(); };
  const up=()=>{ drawing=false; last=null; };
  function draw(x,y){
    const w=2; ctx.strokeStyle="#000"; ctx.lineWidth=w; ctx.lineCap="round";
    if(!last){ last={x,y}; return; }
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke(); last={x,y};
  }
  c.addEventListener('mousedown',down); c.addEventListener('mousemove',move);
  c.addEventListener('mouseup',up); c.addEventListener('mouseleave',up);
  c.addEventListener('touchstart',down,{passive:false});
  c.addEventListener('touchmove',move,{passive:false});
  c.addEventListener('touchend',up);
}
function clearCanvas(id){
  const c=byId(id), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
}
setupSignature('signResp');
setupSignature('signSal');

/* Remplir le gabarit A4 avec les valeurs */
function fillA4(){
  byId('p_date').textContent = byId('date_fiche').value || '‚Äî';
  byId('p_salarie').textContent = byId('salarie').value || '‚Äî';
  byId('p_responsable').textContent = byId('responsable').value || '‚Äî';

  byId('p_abs_prev_date').textContent = byId('abs_prev_date').value || '‚Äî';
  byId('p_abs_prev_shift').textContent = byId('abs_prev_shift').value || '‚Äî';
  byId('tick_abs_prev').textContent = byId('abs_prev').checked ? '‚òëÔ∏é' : '';

  byId('p_abs_np_date').textContent = byId('abs_np_date').value || '‚Äî';
  byId('tick_abs_np').textContent = byId('abs_np').checked ? '‚òëÔ∏é' : '';

  byId('p_ret_prev').textContent = byId('ret_prev_duree').value || '‚Äî';
  byId('tick_ret_prev').textContent = byId('ret_prev').checked ? '‚òëÔ∏é' : '';

  byId('p_ret_np').textContent = byId('ret_np_duree').value || '‚Äî';
  byId('tick_ret_np').textContent = byId('ret_np').checked ? '‚òëÔ∏é' : '';

  byId('p_autre').textContent = byId('autre_detail').value || '‚Äî';
  byId('tick_autre').textContent = byId('autre').checked ? '‚òëÔ∏é' : '';

  byId('p_origine').innerHTML = nl2br(byId('origine').value || '‚Äî');
  byId('p_action').innerHTML  = nl2br(byId('action').value  || '‚Äî');
  byId('p_fait_le').textContent = byId('fait_le').value || '‚Äî';

  // signatures en dataURL PNG (fond blanc d√©j√† dessin√©)
  byId('p_sig_resp').src = byId('signResp').toDataURL('image/png');
  byId('p_sig_sal').src  = byId('signSal').toDataURL('image/png');
}

/* PDF √† partir du gabarit A4 uniquement */
async function makePdf(){
  fillA4();

  // Attendre logo si besoin
  await new Promise(r=>{
    const img = byId('logoA4');
    if (img.complete) return r();
    img.addEventListener('load', r, {once:true});
    img.addEventListener('error', r, {once:true});
  });

  const el = byId('sheetA4');
  const opt = {
    margin: 0,
    filename: `Fiche_Incident_${(byId('salarie').value||'SansNom').replace(/\s+/g,'_')}_${(byId('date_fiche').value||'SansDate')}.pdf`,
    html2canvas: { scale: 2, useCORS: true, scrollY: 0, backgroundColor: '#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all'] }
  };
  await html2pdf().set(opt).from(el).save();
}

/* Envoi au serveur (si tu utilises ton proxy Cloudflare) */
async function sendToServer(){
  fillA4();
  const el = byId('sheetA4');
  const blob = await html2pdf().set({
    margin:0,
    html2canvas:{ scale:2, useCORS:true, scrollY:0, backgroundColor:'#ffffff' },
    jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
  }).from(el).outputPdf('blob');

  const buf = await blob.arrayBuffer();
  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));

  const meta = {
    salarie: byId('salarie').value || 'Inconnu',
    responsable: byId('responsable').value || 'N/A',
    date_fiche: byId('date_fiche').value || ''
  };

  try{
    const res = await fetch('https://otacos-proxy.contact-otacosbsm.workers.dev/', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ meta, b64 })
    });
    const ct = res.headers.get('content-type')||'';
    if (ct.includes('application/json')){
      const j = await res.json();
      if (j.status !== 'ok') throw new Error(j.message || 'Erreur c√¥t√© serveur');
      alert('‚úÖ Fiche envoy√©e.');
    } else if (!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status} - ${t.slice(0,200)}`);
    } else {
      alert('‚úÖ Fiche envoy√©e (r√©ponse non-JSON).');
    }
  }catch(err){
    alert('‚ö†Ô∏è Envoi impossible : '+err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
